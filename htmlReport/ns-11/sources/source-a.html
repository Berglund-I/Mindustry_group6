


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > MapObjectivesCanvas</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">mindustry.editor</a>
</div>

<h1>Coverage Summary for Class: MapObjectivesCanvas (mindustry.editor)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MapObjectivesCanvas</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/23)
  </span>
</td>
</tr>
  <tr>
    <td class="name">MapObjectivesCanvas$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MapObjectivesCanvas$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MapObjectivesCanvas$ObjectiveTilemap</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/101)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MapObjectivesCanvas$ObjectiveTilemap$ObjectiveTile</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MapObjectivesCanvas$ObjectiveTilemap$ObjectiveTile$Connector</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MapObjectivesCanvas$ObjectiveTilemap$ObjectiveTile$Connector$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MapObjectivesCanvas$ObjectiveTilemap$ObjectiveTile$Connector$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MapObjectivesCanvas$ObjectiveTilemap$ObjectiveTile$Mover</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/259)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package mindustry.editor;
&nbsp;
&nbsp;import arc.*;
&nbsp;import arc.graphics.g2d.*;
&nbsp;import arc.input.*;
&nbsp;import arc.math.*;
&nbsp;import arc.math.geom.*;
&nbsp;import arc.scene.event.*;
&nbsp;import arc.scene.ui.*;
&nbsp;import arc.scene.ui.layout.*;
&nbsp;import arc.struct.*;
&nbsp;import arc.util.*;
&nbsp;import mindustry.editor.MapObjectivesCanvas.ObjectiveTilemap.ObjectiveTile.*;
&nbsp;import mindustry.editor.MapObjectivesDialog.*;
&nbsp;import mindustry.game.MapObjectives.*;
&nbsp;import mindustry.gen.*;
&nbsp;import mindustry.graphics.*;
&nbsp;import mindustry.ui.*;
&nbsp;import mindustry.ui.dialogs.*;
&nbsp;
&nbsp;import static mindustry.Vars.*;
&nbsp;
&nbsp;@SuppressWarnings(&quot;unchecked&quot;)
<b class="nc">&nbsp;public class MapObjectivesCanvas extends WidgetGroup{</b>
&nbsp;    public static final int
&nbsp;        objWidth = 5, objHeight = 2,
&nbsp;        bounds = 100;
&nbsp;
<b class="nc">&nbsp;    public final float unitSize = Scl.scl(48f);</b>
&nbsp;
<b class="nc">&nbsp;    public Seq&lt;MapObjective&gt; objectives = new Seq&lt;&gt;();</b>
&nbsp;    public ObjectiveTilemap tilemap;
&nbsp;
&nbsp;    protected MapObjective query;
&nbsp;
&nbsp;    private boolean pressed;
&nbsp;    private long visualPressed;
<b class="nc">&nbsp;    private int queryX = -objWidth, queryY = -objHeight;</b>
&nbsp;
<b class="nc">&nbsp;    public MapObjectivesCanvas(){</b>
<b class="nc">&nbsp;        setFillParent(true);</b>
<b class="nc">&nbsp;        addChild(tilemap = new ObjectiveTilemap());</b>
&nbsp;
<b class="nc">&nbsp;        addCaptureListener(new InputListener(){</b>
&nbsp;            @Override
&nbsp;            public boolean touchDown(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                if(query != null &amp;&amp; button == KeyCode.mouseRight){</b>
<b class="nc">&nbsp;                    stopQuery();</b>
&nbsp;
<b class="nc">&nbsp;                    event.stop();</b>
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                }else{
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        addCaptureListener(new ElementGestureListener(){</b>
<b class="nc">&nbsp;            int pressPointer = -1;</b>
&nbsp;
&nbsp;            @Override
&nbsp;            public void pan(InputEvent event, float x, float y, float deltaX, float deltaY){
<b class="nc">&nbsp;                if(tilemap.moving != null || tilemap.connecting != null) return;</b>
<b class="nc">&nbsp;                tilemap.x = Mathf.clamp(tilemap.x + deltaX, -bounds * unitSize + width, bounds * unitSize);</b>
<b class="nc">&nbsp;                tilemap.y = Mathf.clamp(tilemap.y + deltaY, -bounds * unitSize + height, bounds * unitSize);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void tap(InputEvent event, float x, float y, int count, KeyCode button){
<b class="nc">&nbsp;                if(query == null) return;</b>
&nbsp;
<b class="nc">&nbsp;                Vec2 pos = localToDescendantCoordinates(tilemap, Tmp.v1.set(x, y));</b>
<b class="nc">&nbsp;                queryX = Mathf.round((pos.x - objWidth * unitSize / 2f) / unitSize);</b>
<b class="nc">&nbsp;                queryY = Mathf.floor((pos.y - unitSize) / unitSize);</b>
&nbsp;
&nbsp;                // In mobile, placing the query is done in a separate button.
<b class="nc">&nbsp;                if(!mobile) placeQuery();</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void touchDown(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                if(pressPointer != -1) return;</b>
<b class="nc">&nbsp;                pressPointer = pointer;</b>
<b class="nc">&nbsp;                pressed = true;</b>
<b class="nc">&nbsp;                visualPressed = Time.millis() + 100;</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void touchUp(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                if(pointer == pressPointer){</b>
<b class="nc">&nbsp;                    pressPointer = -1;</b>
<b class="nc">&nbsp;                    pressed = false;</b>
&nbsp;                }
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    public void clearObjectives(){
<b class="nc">&nbsp;        stopQuery();</b>
<b class="nc">&nbsp;        tilemap.clearTiles();</b>
<b class="nc">&nbsp;        tilemap.x = 0f;</b>
<b class="nc">&nbsp;        tilemap.y = 0f;</b>
&nbsp;    }
&nbsp;
&nbsp;    protected void stopQuery(){
<b class="nc">&nbsp;        if(query == null) return;</b>
<b class="nc">&nbsp;        query = null;</b>
&nbsp;
<b class="nc">&nbsp;        Core.graphics.restoreCursor();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void query(MapObjective obj){
<b class="nc">&nbsp;        stopQuery();</b>
<b class="nc">&nbsp;        query = obj;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void placeQuery(){
<b class="nc">&nbsp;        if(isQuerying() &amp;&amp; tilemap.createTile(queryX, queryY, query)){</b>
<b class="nc">&nbsp;            objectives.add(query);</b>
<b class="nc">&nbsp;            stopQuery();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public boolean isQuerying(){
<b class="nc">&nbsp;        return query != null;</b>
&nbsp;    }
&nbsp;
&nbsp;    public boolean isVisualPressed(){
<b class="nc">&nbsp;        return pressed || visualPressed &gt; Time.millis();</b>
&nbsp;    }
&nbsp;
&nbsp;    public class ObjectiveTilemap extends WidgetGroup{
&nbsp;
&nbsp;        /** The connector button that is being pressed. */
&nbsp;        protected @Nullable Connector connecting;
&nbsp;        /** The current tile that is being moved. */
&nbsp;        protected @Nullable ObjectiveTile moving;
&nbsp;
<b class="nc">&nbsp;        public ObjectiveTilemap(){</b>
<b class="nc">&nbsp;            setTransform(false);</b>
<b class="nc">&nbsp;            setSize(getPrefWidth(), getPrefHeight());</b>
<b class="nc">&nbsp;            touchable(() -&gt; isQuerying() ? Touchable.disabled : Touchable.childrenOnly);</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public void draw(){
<b class="nc">&nbsp;            validate();</b>
<b class="nc">&nbsp;            int minX = Math.max(Mathf.floor((x - width - 1f) / unitSize), -bounds), minY = Math.max(Mathf.floor((y - height - 1f) / unitSize), -bounds),</b>
<b class="nc">&nbsp;                maxX = Math.min(Mathf.ceil((x + width + 1f) / unitSize), bounds), maxY = Math.min(Mathf.ceil((y + height + 1f) / unitSize), bounds);</b>
<b class="nc">&nbsp;            float progX = x % unitSize, progY = y % unitSize;</b>
&nbsp;
<b class="nc">&nbsp;            Lines.stroke(3f);</b>
<b class="nc">&nbsp;            Draw.color(Pal.darkestGray, parentAlpha);</b>
&nbsp;
<b class="nc">&nbsp;            for(int x = minX; x &lt;= maxX; x++) Lines.line(progX + x * unitSize, minY * unitSize, progX + x * unitSize, maxY * unitSize);</b>
<b class="nc">&nbsp;            for(int y = minY; y &lt;= maxY; y++) Lines.line(minX * unitSize, progY + y * unitSize, maxX * unitSize, progY + y * unitSize);</b>
&nbsp;
<b class="nc">&nbsp;            if(isQuerying()){</b>
&nbsp;                int tx, ty;
<b class="nc">&nbsp;                if(mobile){</b>
<b class="nc">&nbsp;                    tx = queryX;</b>
<b class="nc">&nbsp;                    ty = queryY;</b>
&nbsp;                }else{
<b class="nc">&nbsp;                    Vec2 pos = screenToLocalCoordinates(Core.input.mouse());</b>
<b class="nc">&nbsp;                    tx = Mathf.round((pos.x - objWidth * unitSize / 2f) / unitSize);</b>
<b class="nc">&nbsp;                    ty = Mathf.floor((pos.y - unitSize) / unitSize);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                Lines.stroke(4f);</b>
<b class="nc">&nbsp;                Draw.color(</b>
<b class="nc">&nbsp;                    isVisualPressed() ? Pal.metalGrayDark : validPlace(tx, ty, null) ? Pal.accent : Pal.remove,</b>
&nbsp;                    parentAlpha
&nbsp;                );
&nbsp;
<b class="nc">&nbsp;                Lines.rect(x + tx * unitSize, y + ty * unitSize, objWidth * unitSize, objHeight * unitSize);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if(moving != null){</b>
&nbsp;                int tx, ty;
<b class="nc">&nbsp;                float x = this.x + (tx = Mathf.round(moving.x / unitSize)) * unitSize;</b>
<b class="nc">&nbsp;                float y = this.y + (ty = Mathf.round(moving.y / unitSize)) * unitSize;</b>
&nbsp;
<b class="nc">&nbsp;                Draw.color(</b>
<b class="nc">&nbsp;                    validPlace(tx, ty, moving) ? Pal.accent : Pal.remove,</b>
&nbsp;                    0.5f * parentAlpha
&nbsp;                );
&nbsp;
<b class="nc">&nbsp;                Fill.crect(x, y, objWidth * unitSize, objHeight * unitSize);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Draw.reset();</b>
<b class="nc">&nbsp;            super.draw();</b>
&nbsp;
<b class="nc">&nbsp;            Draw.reset();</b>
<b class="nc">&nbsp;            Seq&lt;ObjectiveTile&gt; tiles = getChildren().as();</b>
&nbsp;
<b class="nc">&nbsp;            Connector conTarget = null;</b>
<b class="nc">&nbsp;            if(connecting != null){</b>
<b class="nc">&nbsp;                Vec2 pos = connecting.localToAscendantCoordinates(this, Tmp.v1.set(connecting.pointX, connecting.pointY));</b>
<b class="nc">&nbsp;                if(hit(pos.x, pos.y, true) instanceof Connector con &amp;&amp; connecting.canConnectTo(con)) conTarget = con;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            boolean removing = false;</b>
<b class="nc">&nbsp;            for(var tile : tiles){</b>
<b class="nc">&nbsp;                for(var parent : tile.obj.parents){</b>
<b class="nc">&nbsp;                    var parentTile = tiles.find(t -&gt; t.obj == parent);</b>
&nbsp;
<b class="nc">&nbsp;                    if(parentTile == null) continue;</b>
&nbsp;
&nbsp;                    Connector
<b class="nc">&nbsp;                        conFrom = parentTile.conChildren,</b>
<b class="nc">&nbsp;                        conTo = tile.conParent;</b>
&nbsp;
<b class="nc">&nbsp;                    if(conTarget != null &amp;&amp; (</b>
&nbsp;                        (connecting.findParent &amp;&amp; connecting == conTo &amp;&amp; conTarget == conFrom) ||
&nbsp;                        (!connecting.findParent &amp;&amp; connecting == conFrom &amp;&amp; conTarget == conTo)
&nbsp;                    )){
<b class="nc">&nbsp;                        removing = true;</b>
<b class="nc">&nbsp;                        continue;</b>
&nbsp;                    }
&nbsp;
&nbsp;                    Vec2
<b class="nc">&nbsp;                        from = conFrom.localToAscendantCoordinates(this, Tmp.v1.set(conFrom.getWidth() / 2f, conFrom.getHeight() / 2f)).add(x, y),</b>
<b class="nc">&nbsp;                        to = conTo.localToAscendantCoordinates(this, Tmp.v2.set(conTo.getWidth() / 2f, conTo.getHeight() / 2f)).add(x, y);</b>
&nbsp;
<b class="nc">&nbsp;                    drawCurve(false, from.x, from.y, to.x, to.y);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            if(connecting != null){</b>
&nbsp;                Vec2
<b class="nc">&nbsp;                    mouse = (conTarget == null</b>
<b class="nc">&nbsp;                        ? connecting.localToAscendantCoordinates(this, Tmp.v1.set(connecting.pointX, connecting.pointY))</b>
<b class="nc">&nbsp;                        : conTarget.localToAscendantCoordinates(this, Tmp.v1.set(conTarget.getWidth() / 2f, conTarget.getHeight() / 2f))</b>
<b class="nc">&nbsp;                    ).add(x, y),</b>
<b class="nc">&nbsp;                    anchor = connecting.localToAscendantCoordinates(this, Tmp.v2.set(connecting.getWidth() / 2f, connecting.getHeight() / 2f)).add(x, y);</b>
&nbsp;
&nbsp;                Vec2
<b class="nc">&nbsp;                    from = connecting.findParent ? mouse : anchor,</b>
<b class="nc">&nbsp;                    to = connecting.findParent ? anchor : mouse;</b>
&nbsp;
<b class="nc">&nbsp;                drawCurve(removing, from.x, from.y, to.x, to.y);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Draw.reset();</b>
&nbsp;        }
&nbsp;
&nbsp;        protected void drawCurve(boolean remove, float x1, float y1, float x2, float y2){
<b class="nc">&nbsp;            Lines.stroke(4f);</b>
<b class="nc">&nbsp;            Draw.color(remove ? Pal.remove : Pal.accent, parentAlpha);</b>
&nbsp;
<b class="nc">&nbsp;            Fill.square(x1, y1, 8f, 45f);</b>
<b class="nc">&nbsp;            Fill.square(x2, y2, 8f, 45f);</b>
&nbsp;
<b class="nc">&nbsp;            float dist = Math.abs(x1 - x2) / 2f;</b>
<b class="nc">&nbsp;            float cx1 = x1 + dist;</b>
<b class="nc">&nbsp;            float cx2 = x2 - dist;</b>
<b class="nc">&nbsp;            Lines.curve(x1, y1, cx1, y1, cx2, y2, x2, y2, Math.max(4, (int) (Mathf.dst(x1, y1, x2, y2) / 4f)));</b>
&nbsp;
<b class="nc">&nbsp;            float progress = (Time.time % (60 * 4)) / (60 * 4);</b>
&nbsp;
<b class="nc">&nbsp;            float t2 = progress * progress;</b>
<b class="nc">&nbsp;            float t3 = progress * t2;</b>
<b class="nc">&nbsp;            float t1 = 1 - progress;</b>
<b class="nc">&nbsp;            float t13 = t1 * t1 * t1;</b>
<b class="nc">&nbsp;            float kx1 = t13 * x1 + 3 * progress * t1 * t1 * cx1 + 3 * t2 * t1 * cx2 + t3 * x2;</b>
<b class="nc">&nbsp;            float ky1 = t13  *y1 + 3 * progress * t1 * t1 * y1 + 3 * t2 * t1 * y2 + t3 * y2;</b>
&nbsp;
<b class="nc">&nbsp;            Fill.circle(kx1, ky1, 6f);</b>
&nbsp;
<b class="nc">&nbsp;            Draw.reset();</b>
&nbsp;        }
&nbsp;
&nbsp;        public boolean validPlace(int x, int y, @Nullable ObjectiveTile ignore){
<b class="nc">&nbsp;            Tmp.r1.set(x, y, objWidth, objHeight).grow(-0.001f);</b>
&nbsp;
<b class="nc">&nbsp;            if(!Tmp.r2.setCentered(0, 0, bounds * 2, bounds * 2).contains(Tmp.r1)){</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            for(var other : children){</b>
<b class="nc">&nbsp;                if(other instanceof ObjectiveTile tile &amp;&amp; tile != ignore &amp;&amp; Tmp.r2.set(tile.tx, tile.ty, objWidth, objHeight).overlaps(Tmp.r1)){</b>
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
&nbsp;        public boolean createTile(MapObjective obj){
<b class="nc">&nbsp;            return createTile(obj.editorX, obj.editorY, obj);</b>
&nbsp;        }
&nbsp;
&nbsp;        public boolean createTile(int x, int y, MapObjective obj){
<b class="nc">&nbsp;            if(!validPlace(x, y, null)) return false;</b>
&nbsp;
<b class="nc">&nbsp;            ObjectiveTile tile = new ObjectiveTile(obj, x, y);</b>
<b class="nc">&nbsp;            tile.pack();</b>
&nbsp;
<b class="nc">&nbsp;            addChild(tile);</b>
&nbsp;
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
&nbsp;        public boolean moveTile(ObjectiveTile tile, int newX, int newY){
<b class="nc">&nbsp;            if(!validPlace(newX, newY, tile)) return false;</b>
&nbsp;
<b class="nc">&nbsp;            tile.pos(newX, newY);</b>
&nbsp;
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
&nbsp;        public void removeTile(ObjectiveTile tile){
<b class="nc">&nbsp;            if(!tile.isDescendantOf(this)) return;</b>
<b class="nc">&nbsp;            tile.remove();</b>
&nbsp;        }
&nbsp;
&nbsp;        public void clearTiles(){
<b class="nc">&nbsp;            clearChildren();</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public float getPrefWidth(){
<b class="nc">&nbsp;            return bounds * unitSize;</b>
&nbsp;        }
&nbsp;
&nbsp;        @Override
&nbsp;        public float getPrefHeight(){
<b class="nc">&nbsp;            return bounds * unitSize;</b>
&nbsp;        }
&nbsp;
&nbsp;        public class ObjectiveTile extends Table{
&nbsp;            public final MapObjective obj;
&nbsp;            public int tx, ty;
&nbsp;
&nbsp;            public final Mover mover;
&nbsp;            public final Connector conParent, conChildren;
&nbsp;
<b class="nc">&nbsp;            public ObjectiveTile(MapObjective obj, int x, int y){</b>
<b class="nc">&nbsp;                this.obj = obj;</b>
<b class="nc">&nbsp;                setTransform(false);</b>
<b class="nc">&nbsp;                setClip(false);</b>
&nbsp;
<b class="nc">&nbsp;                add(conParent = new Connector(true)).size(unitSize / Scl.scl(1f), unitSize * 2 / Scl.scl(1f));</b>
<b class="nc">&nbsp;                table(Tex.whiteui, t -&gt; {</b>
<b class="nc">&nbsp;                    float pad = (unitSize / Scl.scl(1f) - 32f) / 2f - 4f;</b>
<b class="nc">&nbsp;                    t.margin(pad);</b>
<b class="nc">&nbsp;                    t.touchable(() -&gt; Touchable.enabled);</b>
<b class="nc">&nbsp;                    t.setColor(Pal.gray);</b>
&nbsp;
<b class="nc">&nbsp;                    t.labelWrap(obj.typeName())</b>
<b class="nc">&nbsp;                    .style(Styles.outlineLabel)</b>
<b class="nc">&nbsp;                    .left().grow().get()</b>
<b class="nc">&nbsp;                    .setAlignment(Align.left);</b>
&nbsp;
<b class="nc">&nbsp;                    t.row();</b>
&nbsp;
<b class="nc">&nbsp;                    t.table(b -&gt; {</b>
<b class="nc">&nbsp;                        b.left().defaults().size(40f);</b>
&nbsp;
<b class="nc">&nbsp;                        b.button(Icon.pencilSmall, () -&gt; {</b>
<b class="nc">&nbsp;                            BaseDialog dialog = new BaseDialog(&quot;@editor.objectives&quot;);</b>
<b class="nc">&nbsp;                            dialog.cont.pane(Styles.noBarPane, list -&gt; list.top().table(e -&gt; {</b>
<b class="nc">&nbsp;                                e.margin(0f);</b>
<b class="nc">&nbsp;                                MapObjectivesDialog.getInterpreter((Class&lt;MapObjective&gt;)obj.getClass()).build(</b>
<b class="nc">&nbsp;                                    e, obj.typeName(), new TypeInfo(obj.getClass()),</b>
&nbsp;                                    null, null, null,
<b class="nc">&nbsp;                                    () -&gt; obj,</b>
<b class="nc">&nbsp;                                    res -&gt; {}</b>
&nbsp;                                );
<b class="nc">&nbsp;                            }).width(Math.min(Core.graphics.getWidth() * 0.95f / Scl.scl(1f) - Scl.scl(20f), 700f)).fillY()).grow();</b>
&nbsp;
<b class="nc">&nbsp;                            dialog.addCloseButton();</b>
<b class="nc">&nbsp;                            dialog.show();</b>
&nbsp;                        });
<b class="nc">&nbsp;                        b.button(Icon.trashSmall, () -&gt; removeTile(this));</b>
<b class="nc">&nbsp;                    }).left().grow();</b>
<b class="nc">&nbsp;                }).growX().height(unitSize / Scl.scl(1f) * 2).get().addCaptureListener(mover = new Mover());</b>
<b class="nc">&nbsp;                add(conChildren = new Connector(false)).size(unitSize / Scl.scl(1f), unitSize / Scl.scl(1f) * 2);</b>
&nbsp;
<b class="nc">&nbsp;                setSize(getPrefWidth(), getPrefHeight());</b>
<b class="nc">&nbsp;                pos(x, y);</b>
&nbsp;            }
&nbsp;
&nbsp;            public void pos(int x, int y){
<b class="nc">&nbsp;                tx = obj.editorX = x;</b>
<b class="nc">&nbsp;                ty = obj.editorY = y;</b>
<b class="nc">&nbsp;                this.x = x * unitSize;</b>
<b class="nc">&nbsp;                this.y = y * unitSize;</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public float getPrefWidth(){
<b class="nc">&nbsp;                return objWidth * unitSize;</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public float getPrefHeight(){
<b class="nc">&nbsp;                return objHeight * unitSize;</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public boolean remove(){
<b class="nc">&nbsp;                if(super.remove()){</b>
<b class="nc">&nbsp;                    obj.parents.clear();</b>
&nbsp;
<b class="nc">&nbsp;                    var it = objectives.iterator();</b>
<b class="nc">&nbsp;                    while(it.hasNext()){</b>
<b class="nc">&nbsp;                        var next = it.next();</b>
<b class="nc">&nbsp;                        if(next == obj){</b>
<b class="nc">&nbsp;                            it.remove();</b>
&nbsp;                        }else{
<b class="nc">&nbsp;                            next.parents.remove(obj);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
&nbsp;
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                }else{
<b class="nc">&nbsp;                    return false;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            public class Mover extends InputListener{</b>
&nbsp;                public int prevX, prevY;
&nbsp;                public float lastX, lastY;
&nbsp;
&nbsp;                @Override
&nbsp;                public boolean touchDown(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                    if(moving != null) return false;</b>
<b class="nc">&nbsp;                    moving = ObjectiveTile.this;</b>
<b class="nc">&nbsp;                    moving.toFront();</b>
&nbsp;
<b class="nc">&nbsp;                    prevX = moving.tx;</b>
<b class="nc">&nbsp;                    prevY = moving.ty;</b>
&nbsp;
&nbsp;                    // Convert to world pos first because the button gets dragged too.
<b class="nc">&nbsp;                    Vec2 pos = event.listenerActor.localToStageCoordinates(Tmp.v1.set(x, y));</b>
<b class="nc">&nbsp;                    lastX = pos.x;</b>
<b class="nc">&nbsp;                    lastY = pos.y;</b>
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public void touchDragged(InputEvent event, float x, float y, int pointer){
<b class="nc">&nbsp;                    Vec2 pos = event.listenerActor.localToStageCoordinates(Tmp.v1.set(x, y));</b>
&nbsp;
<b class="nc">&nbsp;                    moving.moveBy(pos.x - lastX, pos.y - lastY);</b>
<b class="nc">&nbsp;                    lastX = pos.x;</b>
<b class="nc">&nbsp;                    lastY = pos.y;</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public void touchUp(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                    if(!moveTile(moving,</b>
<b class="nc">&nbsp;                        Mathf.round(moving.x / unitSize),</b>
<b class="nc">&nbsp;                        Mathf.round(moving.y / unitSize)</b>
<b class="nc">&nbsp;                    )) moving.pos(prevX, prevY);</b>
<b class="nc">&nbsp;                    moving = null;</b>
&nbsp;                }
&nbsp;            }
&nbsp;
&nbsp;            public class Connector extends Button{
&nbsp;                public float pointX, pointY;
&nbsp;                public final boolean findParent;
&nbsp;
<b class="nc">&nbsp;                public Connector(boolean findParent){</b>
<b class="nc">&nbsp;                    super(new ButtonStyle(){{</b>
<b class="nc">&nbsp;                        down = findParent ? Tex.buttonSideLeftDown : Tex.buttonSideRightDown;</b>
<b class="nc">&nbsp;                        up = findParent ? Tex.buttonSideLeft : Tex.buttonSideRight;</b>
<b class="nc">&nbsp;                        over = findParent ? Tex.buttonSideLeftOver : Tex.buttonSideRightOver;</b>
&nbsp;                    }});
&nbsp;
<b class="nc">&nbsp;                    this.findParent = findParent;</b>
&nbsp;
<b class="nc">&nbsp;                    clearChildren();</b>
&nbsp;
<b class="nc">&nbsp;                    addCaptureListener(new InputListener(){</b>
<b class="nc">&nbsp;                        int conPointer = -1;</b>
&nbsp;
&nbsp;                        @Override
&nbsp;                        public boolean touchDown(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                            if(conPointer != -1) return false;</b>
<b class="nc">&nbsp;                            conPointer = pointer;</b>
&nbsp;
<b class="nc">&nbsp;                            if(connecting != null) return false;</b>
<b class="nc">&nbsp;                            connecting = Connector.this;</b>
&nbsp;
<b class="nc">&nbsp;                            pointX = x;</b>
<b class="nc">&nbsp;                            pointY = y;</b>
<b class="nc">&nbsp;                            return true;</b>
&nbsp;                        }
&nbsp;
&nbsp;                        @Override
&nbsp;                        public void touchDragged(InputEvent event, float x, float y, int pointer){
<b class="nc">&nbsp;                            if(conPointer != pointer) return;</b>
<b class="nc">&nbsp;                            pointX = x;</b>
<b class="nc">&nbsp;                            pointY = y;</b>
&nbsp;                        }
&nbsp;
&nbsp;                        @Override
&nbsp;                        public void touchUp(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                            if(conPointer != pointer || connecting != Connector.this) return;</b>
<b class="nc">&nbsp;                            conPointer = -1;</b>
&nbsp;
<b class="nc">&nbsp;                            Vec2 pos = Connector.this.localToAscendantCoordinates(ObjectiveTilemap.this, Tmp.v1.set(x, y));</b>
<b class="nc">&nbsp;                            if(ObjectiveTilemap.this.hit(pos.x, pos.y, true) instanceof Connector con &amp;&amp; con.canConnectTo(Connector.this)){</b>
<b class="nc">&nbsp;                                if(findParent){</b>
<b class="nc">&nbsp;                                    if(!obj.parents.remove(con.tile().obj)) obj.parents.add(con.tile().obj);</b>
&nbsp;                                }else{
<b class="nc">&nbsp;                                    if(!con.tile().obj.parents.remove(obj)) con.tile().obj.parents.add(obj);</b>
&nbsp;                                }
&nbsp;                            }
&nbsp;
<b class="nc">&nbsp;                            connecting = null;</b>
&nbsp;                        }
&nbsp;                    });
&nbsp;                }
&nbsp;
&nbsp;                public boolean canConnectTo(Connector other){
<b class="nc">&nbsp;                    return</b>
&nbsp;                        findParent != other.findParent &amp;&amp;
<b class="nc">&nbsp;                        tile() != other.tile();</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public void draw(){
<b class="nc">&nbsp;                    super.draw();</b>
<b class="nc">&nbsp;                    float cx = x + width / 2f;</b>
<b class="nc">&nbsp;                    float cy = y + height / 2f;</b>
&nbsp;
&nbsp;                    // these are all magic numbers tweaked until they looked good in-game, don&#39;t mind them.
<b class="nc">&nbsp;                    Lines.stroke(3f, Pal.accent);</b>
<b class="nc">&nbsp;                    if(findParent){</b>
<b class="nc">&nbsp;                        Lines.line(cx, cy + 9f, cx + 9f, cy);</b>
<b class="nc">&nbsp;                        Lines.line(cx + 9f, cy, cx, cy - 9f);</b>
&nbsp;                    }else{
<b class="nc">&nbsp;                        Lines.square(cx, cy, 9f, 45f);</b>
&nbsp;                    }
&nbsp;                }
&nbsp;
&nbsp;                public ObjectiveTile tile(){
<b class="nc">&nbsp;                    return ObjectiveTile.this;</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public boolean isPressed(){
<b class="nc">&nbsp;                    return super.isPressed() || connecting == this;</b>
&nbsp;                }
&nbsp;
&nbsp;                @Override
&nbsp;                public boolean isOver(){
<b class="nc">&nbsp;                    return super.isOver() &amp;&amp; (connecting == null || connecting.canConnectTo(this));</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-10-10 14:03</div>
</div>
</body>
</html>
