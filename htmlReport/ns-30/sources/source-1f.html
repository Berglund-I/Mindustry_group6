


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > PlanetDialog</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">mindustry.ui.dialogs</a>
</div>

<h1>Coverage Summary for Class: PlanetDialog (mindustry.ui.dialogs)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">PlanetDialog</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/71)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/648)
  </span>
</td>
</tr>
  <tr>
    <td class="name">PlanetDialog$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PlanetDialog$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PlanetDialog$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PlanetDialog$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PlanetDialog$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PlanetDialog$5$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PlanetDialog$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/43)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">PlanetDialog$Mode</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/93)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/730)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package mindustry.ui.dialogs;
&nbsp;
&nbsp;import arc.*;
&nbsp;import arc.assets.loaders.TextureLoader.*;
&nbsp;import arc.func.*;
&nbsp;import arc.graphics.*;
&nbsp;import arc.graphics.Texture.*;
&nbsp;import arc.graphics.g2d.*;
&nbsp;import arc.graphics.gl.*;
&nbsp;import arc.input.*;
&nbsp;import arc.math.*;
&nbsp;import arc.math.geom.*;
&nbsp;import arc.scene.*;
&nbsp;import arc.scene.event.*;
&nbsp;import arc.scene.style.*;
&nbsp;import arc.scene.ui.*;
&nbsp;import arc.scene.ui.layout.*;
&nbsp;import arc.struct.*;
&nbsp;import arc.util.*;
&nbsp;import mindustry.*;
&nbsp;import mindustry.content.*;
&nbsp;import mindustry.content.TechTree.*;
&nbsp;import mindustry.core.*;
&nbsp;import mindustry.ctype.*;
&nbsp;import mindustry.game.EventType.*;
&nbsp;import mindustry.game.Objectives.*;
&nbsp;import mindustry.game.SectorInfo.*;
&nbsp;import mindustry.game.*;
&nbsp;import mindustry.gen.*;
&nbsp;import mindustry.graphics.*;
&nbsp;import mindustry.graphics.g3d.PlanetGrid.*;
&nbsp;import mindustry.graphics.g3d.*;
&nbsp;import mindustry.input.*;
&nbsp;import mindustry.maps.*;
&nbsp;import mindustry.type.*;
&nbsp;import mindustry.ui.*;
&nbsp;import mindustry.world.blocks.storage.*;
&nbsp;import mindustry.world.blocks.storage.CoreBlock.*;
&nbsp;
&nbsp;import static arc.Core.*;
&nbsp;import static mindustry.Vars.*;
&nbsp;import static mindustry.graphics.g3d.PlanetRenderer.*;
&nbsp;import static mindustry.ui.dialogs.PlanetDialog.Mode.*;
&nbsp;
&nbsp;public class PlanetDialog extends BaseDialog implements PlanetInterfaceRenderer{
&nbsp;    //if true, enables launching anywhere for testing
<b class="nc">&nbsp;    public static boolean debugSelect = false;</b>
<b class="nc">&nbsp;    public static float sectorShowDuration = 60f * 2.4f;</b>
&nbsp;
<b class="nc">&nbsp;    public final FrameBuffer buffer = new FrameBuffer(2, 2, true);</b>
<b class="nc">&nbsp;    public final LaunchLoadoutDialog loadouts = new LaunchLoadoutDialog();</b>
<b class="nc">&nbsp;    public final PlanetRenderer planets = renderer.planets;</b>
&nbsp;
<b class="nc">&nbsp;    public PlanetParams state = new PlanetParams();</b>
<b class="nc">&nbsp;    public float zoom = 1f;</b>
&nbsp;    public @Nullable Sector selected, hovered, launchSector;
<b class="nc">&nbsp;    public Mode mode = look;</b>
&nbsp;    public boolean launching;
<b class="nc">&nbsp;    public Cons&lt;Sector&gt; listener = s -&gt; {};</b>
&nbsp;
<b class="nc">&nbsp;    public Seq&lt;Sector&gt; newPresets = new Seq&lt;&gt;();</b>
<b class="nc">&nbsp;    public float presetShow = 0f;</b>
<b class="nc">&nbsp;    public boolean showed = false, sectorsShown;</b>
<b class="nc">&nbsp;    public String searchText = &quot;&quot;;</b>
&nbsp;
<b class="nc">&nbsp;    public Table sectorTop = new Table(), notifs = new Table(), expandTable = new Table();</b>
<b class="nc">&nbsp;    public Label hoverLabel = new Label(&quot;&quot;);</b>
&nbsp;
&nbsp;    private Texture[] planetTextures;
<b class="nc">&nbsp;    private CampaignRulesDialog campaignRules = new CampaignRulesDialog();</b>
&nbsp;
&nbsp;    public PlanetDialog(){
<b class="nc">&nbsp;        super(&quot;&quot;, Styles.fullDialog);</b>
&nbsp;
<b class="nc">&nbsp;        state.renderer = this;</b>
<b class="nc">&nbsp;        state.drawUi = true;</b>
&nbsp;
<b class="nc">&nbsp;        shouldPause = true;</b>
<b class="nc">&nbsp;        state.planet = content.getByName(ContentType.planet, Core.settings.getString(&quot;lastplanet&quot;, &quot;serpulo&quot;));</b>
<b class="nc">&nbsp;        if(state.planet == null) state.planet = Planets.serpulo;</b>
&nbsp;
<b class="nc">&nbsp;        addListener(new InputListener(){</b>
&nbsp;            @Override
&nbsp;            public boolean keyDown(InputEvent event, KeyCode key){
<b class="nc">&nbsp;                if(event.targetActor == PlanetDialog.this &amp;&amp; (key == KeyCode.escape || key == KeyCode.back || key == Core.keybinds.get(Binding.planet_map).key)){</b>
<b class="nc">&nbsp;                    if(showing() &amp;&amp; newPresets.size &gt; 1){</b>
&nbsp;                        //clear all except first, which is the last sector.
<b class="nc">&nbsp;                        newPresets.truncate(1);</b>
<b class="nc">&nbsp;                    }else if(selected != null){</b>
<b class="nc">&nbsp;                        selectSector(null);</b>
&nbsp;                    }else{
<b class="nc">&nbsp;                        Core.app.post(() -&gt; hide());</b>
&nbsp;                    }
<b class="nc">&nbsp;                    return true;</b>
&nbsp;                }
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        hoverLabel.setStyle(Styles.outlineLabel);</b>
<b class="nc">&nbsp;        hoverLabel.setAlignment(Align.center);</b>
&nbsp;
<b class="nc">&nbsp;        rebuildButtons();</b>
&nbsp;
<b class="nc">&nbsp;        onResize(this::rebuildButtons);</b>
&nbsp;
<b class="nc">&nbsp;        dragged((cx, cy) -&gt; {</b>
&nbsp;            //no multitouch drag
<b class="nc">&nbsp;            if(Core.input.getTouches() &gt; 1) return;</b>
&nbsp;
<b class="nc">&nbsp;            if(showing()){</b>
<b class="nc">&nbsp;                newPresets.clear();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            Vec3 pos = state.camPos;</b>
&nbsp;
<b class="nc">&nbsp;            float upV = pos.angle(Vec3.Y);</b>
<b class="nc">&nbsp;            float xscale = 9f, yscale = 10f;</b>
<b class="nc">&nbsp;            float margin = 1;</b>
&nbsp;
&nbsp;            //scale X speed depending on polar coordinate
<b class="nc">&nbsp;            float speed = 1f - Math.abs(upV - 90) / 90f;</b>
&nbsp;
<b class="nc">&nbsp;            pos.rotate(state.camUp, cx / xscale * speed);</b>
&nbsp;
&nbsp;            //prevent user from scrolling all the way up and glitching it out
<b class="nc">&nbsp;            float amount = cy / yscale;</b>
<b class="nc">&nbsp;            amount = Mathf.clamp(upV + amount, margin, 180f - margin) - upV;</b>
&nbsp;
<b class="nc">&nbsp;            pos.rotate(Tmp.v31.set(state.camUp).rotate(state.camDir, 90), amount);</b>
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        addListener(new InputListener(){</b>
&nbsp;            @Override
&nbsp;            public boolean scrolled(InputEvent event, float x, float y, float amountX, float amountY){
<b class="nc">&nbsp;                if(event.targetActor == PlanetDialog.this){</b>
<b class="nc">&nbsp;                    zoom = Mathf.clamp(zoom + amountY / 10f, state.planet.minZoom, 2f);</b>
&nbsp;                }
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        addCaptureListener(new ElementGestureListener(){</b>
<b class="nc">&nbsp;            float lastZoom = -1f;</b>
&nbsp;
&nbsp;            @Override
&nbsp;            public void zoom(InputEvent event, float initialDistance, float distance){
<b class="nc">&nbsp;                if(lastZoom &lt; 0){</b>
<b class="nc">&nbsp;                    lastZoom = zoom;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                zoom = (Mathf.clamp(initialDistance / distance * lastZoom, state.planet.minZoom, 2f));</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void touchUp(InputEvent event, float x, float y, int pointer, KeyCode button){
<b class="nc">&nbsp;                lastZoom = zoom;</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        shown(this::setup);</b>
&nbsp;
&nbsp;        //show selection of Erekir/Serpulo campaign if the user has no bases, and hasn&#39;t selected yet (essentially a &quot;have they played campaign before&quot; check)
<b class="nc">&nbsp;        shown(() -&gt; {</b>
<b class="nc">&nbsp;            if(!settings.getBool(&quot;campaignselect&quot;) &amp;&amp; !content.planets().contains(p -&gt; p.sectors.contains(Sector::hasBase))){</b>
<b class="nc">&nbsp;                var diag = new BaseDialog(&quot;@campaign.select&quot;);</b>
&nbsp;
<b class="nc">&nbsp;                Planet[] selected = {null};</b>
<b class="nc">&nbsp;                var group = new ButtonGroup&lt;&gt;();</b>
<b class="nc">&nbsp;                group.setMinCheckCount(0);</b>
<b class="nc">&nbsp;                state.planet = Planets.sun;</b>
<b class="nc">&nbsp;                Planet[] choices = {Planets.serpulo, Planets.erekir};</b>
<b class="nc">&nbsp;                int i = 0;</b>
<b class="nc">&nbsp;                for(var planet : choices){</b>
<b class="nc">&nbsp;                    TextureRegion tex = new TextureRegion(planetTextures[i]);</b>
&nbsp;
<b class="nc">&nbsp;                    diag.cont.button(b -&gt; {</b>
<b class="nc">&nbsp;                        b.top();</b>
<b class="nc">&nbsp;                        b.add(planet.localizedName).color(Pal.accent).style(Styles.outlineLabel);</b>
<b class="nc">&nbsp;                        b.row();</b>
<b class="nc">&nbsp;                        b.image(new TextureRegionDrawable(tex)).grow().scaling(Scaling.fit);</b>
<b class="nc">&nbsp;                    }, Styles.togglet, () -&gt; selected[0] = planet).size(mobile ? 220f : 320f).group(group);</b>
<b class="nc">&nbsp;                    i ++;</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                diag.cont.row();</b>
<b class="nc">&nbsp;                diag.cont.label(() -&gt; selected[0] == null ? &quot;@campaign.none&quot; : &quot;@campaign.&quot; + selected[0].name).labelAlign(Align.center).style(Styles.outlineLabel).width(440f).wrap().colspan(2);</b>
&nbsp;
<b class="nc">&nbsp;                diag.buttons.button(&quot;@ok&quot;, Icon.ok, () -&gt; {</b>
<b class="nc">&nbsp;                    state.planet = selected[0];</b>
<b class="nc">&nbsp;                    lookAt(state.planet.getStartSector());</b>
<b class="nc">&nbsp;                    selectSector(state.planet.getStartSector());</b>
<b class="nc">&nbsp;                    settings.put(&quot;campaignselect&quot;, true);</b>
<b class="nc">&nbsp;                    diag.hide();</b>
<b class="nc">&nbsp;                }).size(300f, 64f).disabled(b -&gt; selected[0] == null);</b>
&nbsp;
<b class="nc">&nbsp;                app.post(diag::show);</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        planetTextures = new Texture[2];</b>
<b class="nc">&nbsp;        String[] names = {&quot;sprites/planets/serpulo.png&quot;, &quot;sprites/planets/erekir.png&quot;};</b>
<b class="nc">&nbsp;        for(int i = 0; i &lt; names.length; i++){</b>
<b class="nc">&nbsp;            int fi = i;</b>
<b class="nc">&nbsp;            assets.load(names[i], Texture.class, new TextureParameter(){{</b>
<b class="nc">&nbsp;                minFilter = magFilter = TextureFilter.linear;</b>
<b class="nc">&nbsp;            }}).loaded = t -&gt; planetTextures[fi] = t;</b>
<b class="nc">&nbsp;            assets.finishLoadingAsset(names[i]);</b>
&nbsp;        }
&nbsp;
&nbsp;        //unlock defaults for older campaign saves (TODO move? where to?)
<b class="nc">&nbsp;        if(content.planets().contains(p -&gt; p.sectors.contains(Sector::hasBase)) || Blocks.scatter.unlocked() || Blocks.router.unlocked()){</b>
<b class="nc">&nbsp;            Seq.with(Blocks.junction, Blocks.mechanicalDrill, Blocks.conveyor, Blocks.duo, Items.copper, Items.lead).each(UnlockableContent::quietUnlock);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /** show with no limitations, just as a map. */
&nbsp;    @Override
&nbsp;    public Dialog show(){
<b class="nc">&nbsp;        if(net.client()){</b>
<b class="nc">&nbsp;            ui.showInfo(&quot;@map.multiplayer&quot;);</b>
<b class="nc">&nbsp;            return this;</b>
&nbsp;        }
&nbsp;
&nbsp;        //view current planet by default
<b class="nc">&nbsp;        if(Vars.state.rules.sector != null){</b>
<b class="nc">&nbsp;            state.planet = Vars.state.rules.sector.planet;</b>
<b class="nc">&nbsp;            settings.put(&quot;lastplanet&quot;, state.planet.name);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(!selectable(state.planet)){</b>
<b class="nc">&nbsp;            state.planet = Planets.serpulo;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        rebuildButtons();</b>
<b class="nc">&nbsp;        mode = look;</b>
<b class="nc">&nbsp;        state.otherCamPos = null;</b>
<b class="nc">&nbsp;        selected = hovered = launchSector = null;</b>
<b class="nc">&nbsp;        launching = false;</b>
&nbsp;
<b class="nc">&nbsp;        zoom = 1f;</b>
<b class="nc">&nbsp;        state.zoom = 1f;</b>
<b class="nc">&nbsp;        state.uiAlpha = 0f;</b>
<b class="nc">&nbsp;        launchSector = Vars.state.getSector();</b>
<b class="nc">&nbsp;        presetShow = 0f;</b>
<b class="nc">&nbsp;        showed = false;</b>
<b class="nc">&nbsp;        listener = s -&gt; {};</b>
&nbsp;
<b class="nc">&nbsp;        newPresets.clear();</b>
&nbsp;
&nbsp;        //announce new presets
<b class="nc">&nbsp;        for(SectorPreset preset : content.sectors()){</b>
<b class="nc">&nbsp;            if(preset.unlocked() &amp;&amp; !preset.alwaysUnlocked &amp;&amp; !preset.sector.info.shown &amp;&amp; !preset.sector.hasBase() &amp;&amp; preset.planet == state.planet){</b>
<b class="nc">&nbsp;                newPresets.add(preset.sector);</b>
<b class="nc">&nbsp;                preset.sector.info.shown = true;</b>
<b class="nc">&nbsp;                preset.sector.saveInfo();</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if(newPresets.any()){</b>
<b class="nc">&nbsp;            newPresets.add(state.planet.getLastSector());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        newPresets.reverse();</b>
<b class="nc">&nbsp;        updateSelected();</b>
&nbsp;
<b class="nc">&nbsp;        if(state.planet.getLastSector() != null){</b>
<b class="nc">&nbsp;            lookAt(state.planet.getLastSector());</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return super.show();</b>
&nbsp;    }
&nbsp;
&nbsp;    void rebuildButtons(){
<b class="nc">&nbsp;        buttons.clearChildren();</b>
&nbsp;
<b class="nc">&nbsp;        buttons.bottom();</b>
&nbsp;
<b class="nc">&nbsp;        if(Core.graphics.isPortrait()){</b>
<b class="nc">&nbsp;            buttons.add(sectorTop).colspan(2).fillX().row();</b>
<b class="nc">&nbsp;            addBack();</b>
<b class="nc">&nbsp;            addTech();</b>
&nbsp;        }else{
<b class="nc">&nbsp;            addBack();</b>
<b class="nc">&nbsp;            buttons.add().growX();</b>
<b class="nc">&nbsp;            buttons.add(sectorTop).minWidth(230f);</b>
<b class="nc">&nbsp;            buttons.add().growX();</b>
<b class="nc">&nbsp;            addTech();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    void addBack(){
<b class="nc">&nbsp;        buttons.button(&quot;@back&quot;, Icon.left, this::hide).size(200f, 54f).pad(2).bottom();</b>
&nbsp;    }
&nbsp;
&nbsp;    void addTech(){
<b class="nc">&nbsp;        buttons.button(&quot;@techtree&quot;, Icon.tree, () -&gt; ui.research.show()).size(200f, 54f).pad(2).bottom();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void showOverview(){
&nbsp;        //TODO implement later if necessary
&nbsp;        /*
&nbsp;        sectors.captured = Captured Sectors
&nbsp;        sectors.explored = Explored Sectors
&nbsp;        sectors.production.total = Total Production
&nbsp;        sectors.resources.total = Total Resources
&nbsp;         */
<b class="nc">&nbsp;        var dialog = new BaseDialog(&quot;@overview&quot;);</b>
<b class="nc">&nbsp;        dialog.addCloseButton();</b>
&nbsp;
<b class="nc">&nbsp;        dialog.add(&quot;@sectors.captured&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    //TODO not fully implemented, cutscene needed
&nbsp;    public void showPlanetLaunch(Sector sector, Cons&lt;Sector&gt; listener){
<b class="nc">&nbsp;        selected = null;</b>
<b class="nc">&nbsp;        hovered = null;</b>
<b class="nc">&nbsp;        launching = false;</b>
<b class="nc">&nbsp;        this.listener = listener;</b>
<b class="nc">&nbsp;        launchSector = sector;</b>
&nbsp;
&nbsp;        //automatically select next planets;
<b class="nc">&nbsp;        if(sector.planet.launchCandidates.size == 1){</b>
<b class="nc">&nbsp;            state.planet = sector.planet.launchCandidates.first();</b>
<b class="nc">&nbsp;            state.otherCamPos = sector.planet.position;</b>
<b class="nc">&nbsp;            state.otherCamAlpha = 0f;</b>
&nbsp;
&nbsp;            //unlock and highlight sector
<b class="nc">&nbsp;            var destSec = state.planet.sectors.get(state.planet.startSector);</b>
<b class="nc">&nbsp;            var preset = destSec.preset;</b>
<b class="nc">&nbsp;            if(preset != null){</b>
<b class="nc">&nbsp;                preset.unlock();</b>
&nbsp;            }
<b class="nc">&nbsp;            selected = destSec;</b>
<b class="nc">&nbsp;            updateSelected();</b>
<b class="nc">&nbsp;            rebuildExpand();</b>
&nbsp;        }
&nbsp;
&nbsp;        //TODO pan over to correct planet
&nbsp;
&nbsp;        //update view to sector
<b class="nc">&nbsp;        zoom = 1f;</b>
<b class="nc">&nbsp;        state.zoom = 1f;</b>
<b class="nc">&nbsp;        state.uiAlpha = 0f;</b>
&nbsp;
<b class="nc">&nbsp;        mode = planetLaunch;</b>
&nbsp;
<b class="nc">&nbsp;        super.show();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void showSelect(Sector sector, Cons&lt;Sector&gt; listener){
<b class="nc">&nbsp;        selected = null;</b>
<b class="nc">&nbsp;        hovered = null;</b>
<b class="nc">&nbsp;        launching = false;</b>
<b class="nc">&nbsp;        this.listener = listener;</b>
&nbsp;
&nbsp;        //update view to sector
<b class="nc">&nbsp;        lookAt(sector);</b>
<b class="nc">&nbsp;        zoom = 1f;</b>
<b class="nc">&nbsp;        state.zoom = 1f;</b>
<b class="nc">&nbsp;        state.uiAlpha = 0f;</b>
<b class="nc">&nbsp;        state.otherCamPos = null;</b>
<b class="nc">&nbsp;        launchSector = sector;</b>
&nbsp;
<b class="nc">&nbsp;        mode = select;</b>
&nbsp;
<b class="nc">&nbsp;        super.show();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void lookAt(Sector sector){
<b class="nc">&nbsp;        if(sector.tile == Ptile.empty) return;</b>
&nbsp;
&nbsp;        //TODO should this even set `state.planet`? the other lookAt() doesn&#39;t, so...
<b class="nc">&nbsp;        state.planet = sector.planet;</b>
<b class="nc">&nbsp;        sector.planet.lookAt(sector, state.camPos);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void lookAt(Sector sector, float alpha){
<b class="nc">&nbsp;        float len = state.camPos.len();</b>
<b class="nc">&nbsp;        state.camPos.slerp(sector.planet.lookAt(sector, Tmp.v33).setLength(len), alpha);</b>
&nbsp;    }
&nbsp;
&nbsp;    boolean canSelect(Sector sector){
<b class="nc">&nbsp;        if(mode == select) return sector.hasBase() &amp;&amp; launchSector != null &amp;&amp; sector.planet == launchSector.planet;</b>
&nbsp;        //cannot launch to existing sector w/ accelerator TODO test
<b class="nc">&nbsp;        if(mode == planetLaunch) return sector.id == sector.planet.startSector;</b>
<b class="nc">&nbsp;        if(sector.hasBase() || sector.id == sector.planet.startSector) return true;</b>
&nbsp;        //preset sectors can only be selected once unlocked
<b class="nc">&nbsp;        if(sector.preset != null){</b>
<b class="nc">&nbsp;            TechNode node = sector.preset.techNode;</b>
<b class="nc">&nbsp;            return sector.preset.unlocked() || node == null || node.parent == null || (node.parent.content.unlocked() &amp;&amp; (!(node.parent.content instanceof SectorPreset preset) || preset.sector.hasBase()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return sector.planet.generator != null ?</b>
&nbsp;            //use planet impl when possible
<b class="nc">&nbsp;            sector.planet.generator.allowLanding(sector) :</b>
<b class="nc">&nbsp;            sector.hasBase() || sector.near().contains(Sector::hasBase); //near an occupied sector</b>
&nbsp;    }
&nbsp;
&nbsp;    Sector findLauncher(Sector to){
<b class="nc">&nbsp;        Sector launchSector = this.launchSector != null &amp;&amp; this.launchSector.planet == to.planet &amp;&amp; this.launchSector.hasBase() ? this.launchSector : null;</b>
&nbsp;        //directly nearby.
<b class="nc">&nbsp;        if(to.near().contains(launchSector)) return launchSector;</b>
&nbsp;
<b class="nc">&nbsp;        Sector launchFrom = launchSector;</b>
<b class="nc">&nbsp;        if(launchFrom == null || (to.preset == null &amp;&amp; !to.near().contains(launchSector))){</b>
&nbsp;            //TODO pick one with the most resources
<b class="nc">&nbsp;            launchFrom = to.near().find(Sector::hasBase);</b>
<b class="nc">&nbsp;            if(launchFrom == null &amp;&amp; to.preset != null){</b>
<b class="nc">&nbsp;                if(launchSector != null) return launchSector;</b>
<b class="nc">&nbsp;                launchFrom = state.planet.sectors.min(s -&gt; !s.hasBase() ? Float.MAX_VALUE : s.tile.v.dst2(to.tile.v));</b>
<b class="nc">&nbsp;                if(!launchFrom.hasBase()) launchFrom = null;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return launchFrom;</b>
&nbsp;    }
&nbsp;
&nbsp;    boolean showing(){
<b class="nc">&nbsp;        return newPresets.any();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void renderSectors(Planet planet){
&nbsp;
&nbsp;        //draw all sector stuff
<b class="nc">&nbsp;        if(state.uiAlpha &gt; 0.01f){</b>
<b class="nc">&nbsp;            for(Sector sec : planet.sectors){</b>
<b class="nc">&nbsp;                if(canSelect(sec) || sec.unlocked() || debugSelect){</b>
&nbsp;
&nbsp;                    Color color =
<b class="nc">&nbsp;                    sec.hasBase() ? Tmp.c2.set(Team.sharded.color).lerp(Team.crux.color, sec.hasEnemyBase() ? 0.5f : 0f) :</b>
<b class="nc">&nbsp;                    sec.preset != null ?</b>
<b class="nc">&nbsp;                        sec.preset.unlocked() ? Tmp.c2.set(Team.derelict.color).lerp(Color.white, Mathf.absin(Time.time, 10f, 1f)) :</b>
<b class="nc">&nbsp;                        Color.gray :</b>
<b class="nc">&nbsp;                    sec.hasEnemyBase() ? Team.crux.color :</b>
<b class="nc">&nbsp;                    null;</b>
&nbsp;
<b class="nc">&nbsp;                    if(color != null){</b>
<b class="nc">&nbsp;                        planets.drawSelection(sec, Tmp.c1.set(color).mul(0.8f).a(state.uiAlpha), 0.026f, -0.001f);</b>
&nbsp;                    }
<b class="nc">&nbsp;                }else{</b>
<b class="nc">&nbsp;                    planets.fill(sec, Tmp.c1.set(shadowColor).mul(1, 1, 1, state.uiAlpha), -0.001f);</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Sector current = Vars.state.getSector() != null &amp;&amp; Vars.state.getSector().isBeingPlayed() &amp;&amp; Vars.state.getSector().planet == state.planet ? Vars.state.getSector() : null;</b>
&nbsp;
<b class="nc">&nbsp;        if(current != null){</b>
<b class="nc">&nbsp;            planets.fill(current, hoverColor.write(Tmp.c1).mulA(state.uiAlpha), -0.001f);</b>
&nbsp;        }
&nbsp;
&nbsp;        //draw hover border
<b class="nc">&nbsp;        if(hovered != null){</b>
<b class="nc">&nbsp;            planets.fill(hovered, hoverColor.write(Tmp.c1).mulA(state.uiAlpha), -0.001f);</b>
<b class="nc">&nbsp;            planets.drawBorders(hovered, borderColor, state.uiAlpha);</b>
&nbsp;        }
&nbsp;
&nbsp;        //draw selected borders
<b class="nc">&nbsp;        if(selected != null){</b>
<b class="nc">&nbsp;            planets.drawSelection(selected, state.uiAlpha);</b>
<b class="nc">&nbsp;            planets.drawBorders(selected, borderColor, state.uiAlpha);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        planets.batch.flush(Gl.triangles);</b>
&nbsp;
<b class="nc">&nbsp;        if(hovered != null &amp;&amp; !hovered.hasBase()){</b>
<b class="nc">&nbsp;            Sector launchFrom = findLauncher(hovered);</b>
<b class="nc">&nbsp;            if(launchFrom != null &amp;&amp; hovered != launchFrom &amp;&amp; canSelect(hovered)){</b>
<b class="nc">&nbsp;                planets.drawArc(planet, launchFrom.tile.v, hovered.tile.v);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(state.uiAlpha &gt; 0.001f){</b>
<b class="nc">&nbsp;            for(Sector sec : planet.sectors){</b>
<b class="nc">&nbsp;                if(sec.hasBase()){</b>
<b class="nc">&nbsp;                    if(planet.campaignRules.sectorInvasion){</b>
<b class="nc">&nbsp;                        for(Sector enemy : sec.near()){</b>
<b class="nc">&nbsp;                            if(enemy.hasEnemyBase()){</b>
<b class="nc">&nbsp;                                planets.drawArc(planet, enemy.tile.v, sec.tile.v, Team.crux.color.write(Tmp.c2).a(state.uiAlpha), Color.clear, 0.24f, 110f, 25);</b>
&nbsp;                            }
<b class="nc">&nbsp;                        }</b>
&nbsp;                    }
&nbsp;
<b class="nc">&nbsp;                    if(selected != null &amp;&amp; selected != sec &amp;&amp; selected.hasBase()){</b>
&nbsp;                        //imports
<b class="nc">&nbsp;                        if(sec.info.getRealDestination() == selected &amp;&amp; sec.info.anyExports()){</b>
<b class="nc">&nbsp;                            planets.drawArc(planet, sec.tile.v, selected.tile.v, Color.gray.write(Tmp.c2).a(state.uiAlpha), Pal.accent.write(Tmp.c3).a(state.uiAlpha), 0.4f, 90f, 25);</b>
&nbsp;                        }
&nbsp;                        //exports
<b class="nc">&nbsp;                        if(selected.info.getRealDestination() == sec &amp;&amp; selected.info.anyExports()){</b>
<b class="nc">&nbsp;                            planets.drawArc(planet, selected.tile.v, sec.tile.v, Pal.place.write(Tmp.c2).a(state.uiAlpha), Pal.accent.write(Tmp.c3).a(state.uiAlpha), 0.4f, 90f, 25);</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void renderProjections(Planet planet){
<b class="nc">&nbsp;        float iw = 48f/4f;</b>
&nbsp;
<b class="nc">&nbsp;        for(Sector sec : planet.sectors){</b>
<b class="nc">&nbsp;            if(sec != hovered){</b>
<b class="nc">&nbsp;                var preficon = sec.icon();</b>
&nbsp;                var icon =
<b class="nc">&nbsp;                    sec.isAttacked() ? Fonts.getLargeIcon(&quot;warning&quot;) :</b>
<b class="nc">&nbsp;                    !sec.hasBase() &amp;&amp; sec.preset != null &amp;&amp; sec.preset.unlocked() &amp;&amp; preficon == null ?</b>
<b class="nc">&nbsp;                    Fonts.getLargeIcon(&quot;terrain&quot;) :</b>
<b class="nc">&nbsp;                    sec.preset != null &amp;&amp; sec.preset.locked() &amp;&amp; sec.preset.techNode != null &amp;&amp; (sec.preset.techNode.parent == null || !sec.preset.techNode.parent.content.locked()) ? Fonts.getLargeIcon(&quot;lock&quot;) :</b>
<b class="nc">&nbsp;                    preficon;</b>
<b class="nc">&nbsp;                var color = sec.preset != null &amp;&amp; !sec.hasBase() ? Team.derelict.color : Team.sharded.color;</b>
&nbsp;
<b class="nc">&nbsp;                if(icon != null){</b>
<b class="nc">&nbsp;                    planets.drawPlane(sec, () -&gt; {</b>
&nbsp;                        //use white for content icons
<b class="nc">&nbsp;                        Draw.color(preficon == icon &amp;&amp; sec.info.contentIcon != null ? Color.white : color, state.uiAlpha);</b>
<b class="nc">&nbsp;                        Draw.rect(icon, 0, 0, iw, iw * icon.height / icon.width);</b>
&nbsp;                    });
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        Draw.reset();</b>
&nbsp;
<b class="nc">&nbsp;        if(hovered != null &amp;&amp; state.uiAlpha &gt; 0.01f){</b>
<b class="nc">&nbsp;            planets.drawPlane(hovered, () -&gt; {</b>
<b class="nc">&nbsp;                Draw.color(hovered.isAttacked() ? Pal.remove : Color.white, Pal.accent, Mathf.absin(5f, 1f));</b>
<b class="nc">&nbsp;                Draw.alpha(state.uiAlpha);</b>
&nbsp;
<b class="nc">&nbsp;                var icon = hovered.locked() &amp;&amp; !canSelect(hovered) ? Fonts.getLargeIcon(&quot;lock&quot;) : hovered.isAttacked() ? Fonts.getLargeIcon(&quot;warning&quot;) : hovered.icon();</b>
&nbsp;
<b class="nc">&nbsp;                if(icon != null){</b>
<b class="nc">&nbsp;                    Draw.rect(icon, 0, 0, iw, iw * icon.height / icon.width);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                Draw.reset();</b>
&nbsp;            });
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Draw.reset();</b>
&nbsp;    }
&nbsp;
&nbsp;    boolean selectable(Planet planet){
&nbsp;        //TODO what if any sector is selectable?
&nbsp;        //TODO launch criteria - which planets can be launched to? Where should this be defined? Should planets even be selectable?
<b class="nc">&nbsp;        if(mode == select) return planet == state.planet;</b>
<b class="nc">&nbsp;        if(mode == planetLaunch) return launchSector != null &amp;&amp; planet != launchSector.planet &amp;&amp; launchSector.planet.launchCandidates.contains(planet);</b>
<b class="nc">&nbsp;        return (planet.alwaysUnlocked &amp;&amp; planet.isLandable()) || planet.sectors.contains(Sector::hasBase) || debugSelect;</b>
&nbsp;    }
&nbsp;
&nbsp;    void setup(){
<b class="nc">&nbsp;        searchText = &quot;&quot;;</b>
<b class="nc">&nbsp;        zoom = state.zoom = 1f;</b>
<b class="nc">&nbsp;        state.uiAlpha = 1f;</b>
<b class="nc">&nbsp;        ui.minimapfrag.hide();</b>
&nbsp;
<b class="nc">&nbsp;        clearChildren();</b>
&nbsp;
<b class="nc">&nbsp;        margin(0f);</b>
&nbsp;
<b class="nc">&nbsp;        stack(</b>
<b class="nc">&nbsp;        new Element(){</b>
&nbsp;            {
&nbsp;                //add listener to the background rect, so it doesn&#39;t get unnecessary touch input
<b class="nc">&nbsp;                addListener(new ElementGestureListener(){</b>
&nbsp;                    @Override
&nbsp;                    public void tap(InputEvent event, float x, float y, int count, KeyCode button){
<b class="nc">&nbsp;                        if(showing()) return;</b>
&nbsp;
<b class="nc">&nbsp;                        if(hovered != null &amp;&amp; selected == hovered &amp;&amp; count == 2){</b>
<b class="nc">&nbsp;                            playSelected();</b>
&nbsp;                        }
&nbsp;
<b class="nc">&nbsp;                        if(hovered != null &amp;&amp; (canSelect(hovered) || debugSelect)){</b>
<b class="nc">&nbsp;                            selected = hovered;</b>
&nbsp;                        }
&nbsp;
<b class="nc">&nbsp;                        if(selected != null){</b>
<b class="nc">&nbsp;                            updateSelected();</b>
&nbsp;                        }
&nbsp;                    }
&nbsp;                });
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void act(float delta){
<b class="nc">&nbsp;                if(scene.getDialog() == PlanetDialog.this &amp;&amp; (scene.getHoverElement() == null || !scene.getHoverElement().isDescendantOf(e -&gt; e instanceof ScrollPane))){</b>
<b class="nc">&nbsp;                    scene.setScrollFocus(PlanetDialog.this);</b>
&nbsp;                }
&nbsp;
<b class="nc">&nbsp;                super.act(delta);</b>
&nbsp;            }
&nbsp;
&nbsp;            @Override
&nbsp;            public void draw(){
<b class="nc">&nbsp;                planets.render(state);</b>
&nbsp;            }
&nbsp;        },
&nbsp;        //info text
&nbsp;        new Table(t -&gt; {
<b class="nc">&nbsp;            t.touchable = Touchable.disabled;</b>
<b class="nc">&nbsp;            t.top();</b>
<b class="nc">&nbsp;            t.label(() -&gt; mode == select ? &quot;@sectors.select&quot; : &quot;&quot;).style(Styles.outlineLabel).color(Pal.accent);</b>
&nbsp;        }),
&nbsp;        buttons,
&nbsp;
&nbsp;        // planet selection
&nbsp;        new Table(t -&gt; {
<b class="nc">&nbsp;            t.top().left();</b>
<b class="nc">&nbsp;            ScrollPane pane = new ScrollPane(null, Styles.smallPane);</b>
<b class="nc">&nbsp;            t.add(pane).colspan(2).row();</b>
<b class="nc">&nbsp;            t.button(&quot;@campaign.difficulty&quot;, Icon.bookSmall, () -&gt; {</b>
<b class="nc">&nbsp;                campaignRules.show(state.planet);</b>
<b class="nc">&nbsp;            }).margin(12f).size(208f, 40f).padTop(12f).visible(() -&gt; state.planet.allowCampaignRules).row();</b>
<b class="nc">&nbsp;            t.add().height(64f); //padding for close button</b>
<b class="nc">&nbsp;            Table starsTable = new Table(Styles.black);</b>
<b class="nc">&nbsp;            pane.setWidget(starsTable);</b>
<b class="nc">&nbsp;            pane.setScrollingDisabled(true, false);</b>
&nbsp;
<b class="nc">&nbsp;            int starCount = 0;</b>
<b class="nc">&nbsp;            for(Planet star : content.planets()){</b>
<b class="nc">&nbsp;                if(star.solarSystem != star || !content.planets().contains(p -&gt; p.solarSystem == star &amp;&amp; selectable(p))) continue;</b>
&nbsp;
<b class="nc">&nbsp;                starCount++;</b>
<b class="nc">&nbsp;                if(starCount &gt; 1) starsTable.add(star.localizedName).padLeft(10f).padBottom(10f).padTop(10f).left().width(190f).row();</b>
<b class="nc">&nbsp;                Table planetTable = new Table();</b>
<b class="nc">&nbsp;                planetTable.margin(4f); //less padding</b>
<b class="nc">&nbsp;                starsTable.add(planetTable).left().row();</b>
<b class="nc">&nbsp;                for(Planet planet : content.planets()){</b>
<b class="nc">&nbsp;                    if(planet.solarSystem == star &amp;&amp; selectable(planet)){</b>
<b class="nc">&nbsp;                        Button planetButton = planetTable.button(planet.localizedName, Icon.icons.get(planet.icon + &quot;Small&quot;, Icon.icons.get(planet.icon, Icon.commandRallySmall)), Styles.flatTogglet, () -&gt; {</b>
<b class="nc">&nbsp;                            selected = null;</b>
<b class="nc">&nbsp;                            launchSector = null;</b>
<b class="nc">&nbsp;                            if(state.planet != planet){</b>
<b class="nc">&nbsp;                                newPresets.clear();</b>
<b class="nc">&nbsp;                                state.planet = planet;</b>
&nbsp;
<b class="nc">&nbsp;                                selected = null;</b>
<b class="nc">&nbsp;                                updateSelected();</b>
<b class="nc">&nbsp;                                rebuildExpand();</b>
&nbsp;                            }
<b class="nc">&nbsp;                            settings.put(&quot;lastplanet&quot;, planet.name);</b>
<b class="nc">&nbsp;                        }).width(200).height(40).update(bb -&gt; bb.setChecked(state.planet == planet)).with(w -&gt; w.marginLeft(10f)).get();</b>
<b class="nc">&nbsp;                        planetButton.getChildren().get(1).setColor(planet.iconColor);</b>
<b class="nc">&nbsp;                        planetButton.setColor(planet.iconColor);</b>
<b class="nc">&nbsp;                        planetTable.background(Tex.pane).row();</b>
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;        }).visible(() -&gt; mode != select),</b>
&nbsp;
<b class="nc">&nbsp;        new Table(c -&gt; expandTable = c)).grow();</b>
<b class="nc">&nbsp;        rebuildExpand();</b>
&nbsp;    }
&nbsp;
&nbsp;    void rebuildExpand(){
<b class="nc">&nbsp;        Table c = expandTable;</b>
<b class="nc">&nbsp;        c.clear();</b>
<b class="nc">&nbsp;        c.visible(() -&gt; !(graphics.isPortrait() &amp;&amp; mobile));</b>
<b class="nc">&nbsp;        if(state.planet.sectors.contains(Sector::hasBase)){</b>
<b class="nc">&nbsp;            int attacked = state.planet.sectors.count(Sector::isAttacked);</b>
&nbsp;
&nbsp;            //sector notifications &amp; search
<b class="nc">&nbsp;            c.top().right();</b>
<b class="nc">&nbsp;            c.defaults().width(290f);</b>
&nbsp;
<b class="nc">&nbsp;            c.button(bundle.get(&quot;sectorlist&quot;) +</b>
<b class="nc">&nbsp;            (attacked == 0 ? &quot;&quot; : &quot;\n[red]?[lightgray] &quot; + bundle.format(&quot;sectorlist.attacked&quot;, &quot;[red]&quot; + attacked + &quot;[]&quot;)),</b>
<b class="nc">&nbsp;            Icon.downOpen, Styles.squareTogglet, () -&gt; sectorsShown = !sectorsShown)</b>
<b class="nc">&nbsp;            .height(60f).checked(b -&gt; {</b>
<b class="nc">&nbsp;                Image image = (Image)b.getCells().first().get();</b>
<b class="nc">&nbsp;                image.setDrawable(sectorsShown ? Icon.upOpen : Icon.downOpen);</b>
<b class="nc">&nbsp;                return sectorsShown;</b>
<b class="nc">&nbsp;            }).with(t -&gt; t.left().margin(7f)).with(t -&gt; t.getLabelCell().grow().left()).row();</b>
&nbsp;
<b class="nc">&nbsp;            c.collapser(t -&gt; {</b>
<b class="nc">&nbsp;                t.background(Styles.black8);</b>
&nbsp;
<b class="nc">&nbsp;                notifs = t;</b>
<b class="nc">&nbsp;                rebuildList();</b>
<b class="nc">&nbsp;            }, false, () -&gt; sectorsShown).padBottom(64f).row();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    void rebuildList(){
<b class="nc">&nbsp;        if(notifs == null) return;</b>
&nbsp;
<b class="nc">&nbsp;        notifs.clear();</b>
&nbsp;
<b class="nc">&nbsp;        var all = state.planet.sectors.select(Sector::hasBase);</b>
<b class="nc">&nbsp;        all.sort(Structs.comps(Structs.comparingBool(s -&gt; !s.isAttacked()), Structs.comparingInt(s -&gt; s.save == null ? 0 : -(int)s.save.meta.timePlayed)));</b>
&nbsp;
<b class="nc">&nbsp;        notifs.pane(p -&gt; {</b>
<b class="nc">&nbsp;            Runnable[] readd = {null};</b>
&nbsp;
<b class="nc">&nbsp;            p.table(s -&gt; {</b>
<b class="nc">&nbsp;                s.image(Icon.zoom).padRight(4);</b>
<b class="nc">&nbsp;                s.field(searchText, t -&gt; {</b>
<b class="nc">&nbsp;                    searchText = t;</b>
<b class="nc">&nbsp;                    readd[0].run();</b>
<b class="nc">&nbsp;                }).growX().height(50f);</b>
<b class="nc">&nbsp;            }).growX().row();</b>
&nbsp;
<b class="nc">&nbsp;            Table con = p.table().growX().get();</b>
<b class="nc">&nbsp;            con.touchable = Touchable.enabled;</b>
&nbsp;
<b class="nc">&nbsp;            readd[0] = () -&gt; {</b>
<b class="nc">&nbsp;                con.clearChildren();</b>
<b class="nc">&nbsp;                for(Sector sec : all){</b>
<b class="nc">&nbsp;                    if(sec.hasBase() &amp;&amp; (searchText.isEmpty() || sec.name().toLowerCase().contains(searchText.toLowerCase()))){</b>
<b class="nc">&nbsp;                        con.button(t -&gt; {</b>
<b class="nc">&nbsp;                            t.marginRight(10f);</b>
<b class="nc">&nbsp;                            t.left();</b>
<b class="nc">&nbsp;                            t.defaults().growX();</b>
&nbsp;
<b class="nc">&nbsp;                            t.table(head -&gt; {</b>
<b class="nc">&nbsp;                                head.left().defaults();</b>
&nbsp;
<b class="nc">&nbsp;                                if(sec.isAttacked()){</b>
<b class="nc">&nbsp;                                    head.image(Icon.warningSmall).update(i -&gt; {</b>
<b class="nc">&nbsp;                                        i.color.set(Pal.accent).lerp(Pal.remove, Mathf.absin(Time.globalTime, 9f, 1f));</b>
<b class="nc">&nbsp;                                    }).padRight(4f);</b>
&nbsp;                                }
&nbsp;
<b class="nc">&nbsp;                                String ic = sec.iconChar() == null ? &quot;&quot; : sec.iconChar() + &quot; &quot;;</b>
&nbsp;
<b class="nc">&nbsp;                                head.add(ic + sec.name()).growX().wrap();</b>
<b class="nc">&nbsp;                            }).growX().row();</b>
&nbsp;
<b class="nc">&nbsp;                            if(sec.isAttacked()){</b>
<b class="nc">&nbsp;                                addSurvivedInfo(sec, t, true);</b>
&nbsp;                            }
&nbsp;                        }, Styles.underlineb, () -&gt; {
<b class="nc">&nbsp;                            lookAt(sec);</b>
<b class="nc">&nbsp;                            selected = sec;</b>
<b class="nc">&nbsp;                            updateSelected();</b>
<b class="nc">&nbsp;                        }).margin(8f).marginLeft(13f).marginBottom(6f).marginTop(6f).padBottom(3f).padTop(3f).growX().checked(b -&gt; selected == sec).row();</b>
&nbsp;                        //for resources: .tooltip(sec.info.resources.toString(&quot;&quot;, u -&gt; u.emoji()))
&nbsp;                    }
<b class="nc">&nbsp;                }</b>
&nbsp;
<b class="nc">&nbsp;                if(con.getChildren().isEmpty()){</b>
<b class="nc">&nbsp;                    con.add(&quot;@none.found&quot;).pad(10f);</b>
&nbsp;                }
&nbsp;            };
&nbsp;
<b class="nc">&nbsp;            readd[0].run();</b>
<b class="nc">&nbsp;        }).grow().scrollX(false);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void draw(){
<b class="nc">&nbsp;        boolean doBuffer = color.a &lt; 0.99f;</b>
&nbsp;
<b class="nc">&nbsp;        if(doBuffer){</b>
<b class="nc">&nbsp;            buffer.resize(Core.graphics.getWidth(), Core.graphics.getHeight());</b>
<b class="nc">&nbsp;            buffer.begin(Color.clear);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        super.draw();</b>
&nbsp;
<b class="nc">&nbsp;        if(doBuffer){</b>
<b class="nc">&nbsp;            buffer.end();</b>
&nbsp;
<b class="nc">&nbsp;            Draw.color(color);</b>
<b class="nc">&nbsp;            Draw.rect(Draw.wrap(buffer.getTexture()), width/2f, height/2f, width, -height);</b>
<b class="nc">&nbsp;            Draw.color();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void act(float delta){
<b class="nc">&nbsp;        super.act(delta);</b>
&nbsp;
&nbsp;        //update lerp
<b class="nc">&nbsp;        if(state.otherCamPos != null){</b>
<b class="nc">&nbsp;            state.otherCamAlpha = Mathf.lerpDelta(state.otherCamAlpha, 1f, 0.05f);</b>
<b class="nc">&nbsp;            state.camPos.set(0f, camLength, 0.1f);</b>
&nbsp;
<b class="nc">&nbsp;            if(Mathf.equal(state.otherCamAlpha, 1f, 0.01f)){</b>
&nbsp;                //TODO change zoom too
<b class="nc">&nbsp;                state.camPos.set(Tmp.v31.set(state.otherCamPos).lerp(state.planet.position, state.otherCamAlpha).add(state.camPos).sub(state.planet.position));</b>
&nbsp;
<b class="nc">&nbsp;                state.otherCamPos = null;</b>
&nbsp;                //announce new sector
<b class="nc">&nbsp;                newPresets.add(state.planet.sectors.get(state.planet.startSector));</b>
&nbsp;
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(hovered != null &amp;&amp; !mobile &amp;&amp; state.planet.hasGrid()){</b>
<b class="nc">&nbsp;            addChild(hoverLabel);</b>
<b class="nc">&nbsp;            hoverLabel.toFront();</b>
<b class="nc">&nbsp;            hoverLabel.touchable = Touchable.disabled;</b>
<b class="nc">&nbsp;            hoverLabel.color.a = state.uiAlpha;</b>
&nbsp;
<b class="nc">&nbsp;            Vec3 pos = hovered.planet.project(hovered, planets.cam, Tmp.v31);</b>
<b class="nc">&nbsp;            hoverLabel.setPosition(pos.x - Core.scene.marginLeft, pos.y - Core.scene.marginBottom, Align.center);</b>
&nbsp;
<b class="nc">&nbsp;            hoverLabel.getText().setLength(0);</b>
<b class="nc">&nbsp;            if(hovered != null){</b>
<b class="nc">&nbsp;                StringBuilder tx = hoverLabel.getText();</b>
<b class="nc">&nbsp;                if(!canSelect(hovered)){</b>
<b class="nc">&nbsp;                    if(mode == planetLaunch){</b>
<b class="nc">&nbsp;                        tx.append(&quot;[gray]&quot;).append(Iconc.cancel);</b>
&nbsp;                    }else{
<b class="nc">&nbsp;                        tx.append(&quot;[gray]&quot;).append(Iconc.lock).append(&quot; &quot;).append(Core.bundle.get(&quot;locked&quot;));</b>
&nbsp;                    }
&nbsp;                }else{
<b class="nc">&nbsp;                    tx.append(&quot;[accent][[ [white]&quot;).append(hovered.name()).append(&quot;[accent] ]&quot;);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            hoverLabel.invalidateHierarchy();</b>
<b class="nc">&nbsp;        }else{</b>
<b class="nc">&nbsp;            hoverLabel.remove();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(launching &amp;&amp; selected != null){</b>
<b class="nc">&nbsp;            lookAt(selected, 0.1f);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(showing()){</b>
<b class="nc">&nbsp;            Sector to = newPresets.peek();</b>
&nbsp;
<b class="nc">&nbsp;            presetShow += Time.delta;</b>
&nbsp;
<b class="nc">&nbsp;            lookAt(to, 0.11f);</b>
<b class="nc">&nbsp;            zoom = 0.75f;</b>
&nbsp;
<b class="nc">&nbsp;            if(presetShow &gt;= 20f &amp;&amp; !showed &amp;&amp; newPresets.size &gt; 1){</b>
<b class="nc">&nbsp;                showed = true;</b>
<b class="nc">&nbsp;                ui.announce(Iconc.lockOpen + &quot; [accent]&quot; + to.name(), 2f);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if(presetShow &gt; sectorShowDuration){</b>
<b class="nc">&nbsp;                newPresets.pop();</b>
<b class="nc">&nbsp;                showed = false;</b>
<b class="nc">&nbsp;                presetShow = 0f;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(state.planet.hasGrid()){</b>
<b class="nc">&nbsp;            hovered = Core.scene.getDialog() == this ? state.planet.getSector(planets.cam.getMouseRay(), PlanetRenderer.outlineRad * state.planet.radius) : null;</b>
<b class="nc">&nbsp;        }else if(state.planet.isLandable()){</b>
<b class="nc">&nbsp;            boolean wasNull = selected == null;</b>
&nbsp;            //always have the first sector selected.
&nbsp;            //TODO better support for multiple sectors in gridless planets?
<b class="nc">&nbsp;            hovered = selected = state.planet.sectors.first();</b>
&nbsp;
&nbsp;            //autoshow
<b class="nc">&nbsp;            if(wasNull){</b>
<b class="nc">&nbsp;                updateSelected();</b>
&nbsp;            }
<b class="nc">&nbsp;        }else{</b>
<b class="nc">&nbsp;            hovered = selected = null;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        state.zoom = Mathf.lerpDelta(state.zoom, zoom, 0.4f);</b>
<b class="nc">&nbsp;        state.uiAlpha = Mathf.lerpDelta(state.uiAlpha, Mathf.num(state.zoom &lt; 1.9f), 0.1f);</b>
&nbsp;    }
&nbsp;
&nbsp;    void displayItems(Table c, float scl, ObjectMap&lt;Item, ExportStat&gt; stats, String name){
<b class="nc">&nbsp;        displayItems(c, scl, stats, name, t -&gt; {});</b>
&nbsp;    }
&nbsp;
&nbsp;    void displayItems(Table c, float scl, ObjectMap&lt;Item, ExportStat&gt; stats, String name, Cons&lt;Table&gt; builder){
<b class="nc">&nbsp;        Table t = new Table().left();</b>
&nbsp;
<b class="nc">&nbsp;        int i = 0;</b>
<b class="nc">&nbsp;        for(var item : content.items()){</b>
<b class="nc">&nbsp;            var stat = stats.get(item);</b>
<b class="nc">&nbsp;            if(stat == null) continue;</b>
<b class="nc">&nbsp;            int total = (int)(stat.mean * 60 * scl);</b>
<b class="nc">&nbsp;            if(total &gt; 1){</b>
<b class="nc">&nbsp;                t.image(item.uiIcon).padRight(3);</b>
<b class="nc">&nbsp;                t.add(UI.formatAmount(total) + &quot; &quot; + Core.bundle.get(&quot;unit.perminute&quot;)).color(Color.lightGray).padRight(3);</b>
<b class="nc">&nbsp;                if(++i % 3 == 0){</b>
<b class="nc">&nbsp;                    t.row();</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if(t.getChildren().any()){</b>
<b class="nc">&nbsp;            c.defaults().left();</b>
<b class="nc">&nbsp;            c.add(name).row();</b>
<b class="nc">&nbsp;            builder.get(c);</b>
<b class="nc">&nbsp;            c.add(t).padLeft(10f).row();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    void showStats(Sector sector){
<b class="nc">&nbsp;        BaseDialog dialog = new BaseDialog(sector.name());</b>
&nbsp;
<b class="nc">&nbsp;        dialog.cont.pane(c -&gt; {</b>
<b class="nc">&nbsp;            c.defaults().padBottom(5);</b>
&nbsp;
<b class="nc">&nbsp;            if(sector.preset != null &amp;&amp; sector.preset.description != null){</b>
<b class="nc">&nbsp;                c.add(sector.preset.displayDescription()).width(420f).wrap().left().row();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            c.add(Core.bundle.get(&quot;sectors.time&quot;) + &quot; [accent]&quot; + sector.save.getPlayTime()).left().row();</b>
&nbsp;
<b class="nc">&nbsp;            if(sector.info.waves &amp;&amp; sector.hasBase()){</b>
<b class="nc">&nbsp;                c.add(Core.bundle.get(&quot;sectors.wave&quot;) + &quot; [accent]&quot; + (sector.info.wave + sector.info.wavesPassed)).left().row();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if(sector.isAttacked() || !sector.hasBase()){</b>
<b class="nc">&nbsp;                c.add(Core.bundle.get(&quot;sectors.threat&quot;) + &quot; [accent]&quot; + sector.displayThreat()).left().row();</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if(sector.save != null &amp;&amp; sector.info.resources.any()){</b>
<b class="nc">&nbsp;                c.add(&quot;@sectors.resources&quot;).left().row();</b>
<b class="nc">&nbsp;                c.table(t -&gt; {</b>
<b class="nc">&nbsp;                    for(UnlockableContent uc : sector.info.resources){</b>
<b class="nc">&nbsp;                        if(uc == null) continue;</b>
<b class="nc">&nbsp;                        t.image(uc.uiIcon).scaling(Scaling.fit).padRight(3).size(iconSmall);</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                }).padLeft(10f).left().row();</b>
&nbsp;            }
&nbsp;
&nbsp;            //production
<b class="nc">&nbsp;            displayItems(c, sector.getProductionScale(), sector.info.production, &quot;@sectors.production&quot;);</b>
&nbsp;
&nbsp;            //export
<b class="nc">&nbsp;            displayItems(c, sector.getProductionScale(), sector.info.export, &quot;@sectors.export&quot;, t -&gt; {</b>
<b class="nc">&nbsp;                if(sector.info.destination != null &amp;&amp; sector.info.destination.hasBase()){</b>
<b class="nc">&nbsp;                    String ic = sector.info.destination.iconChar();</b>
<b class="nc">&nbsp;                    t.add(Iconc.rightOpen + &quot; &quot; + (ic == null || ic.isEmpty() ? &quot;&quot; : ic + &quot; &quot;) + sector.info.destination.name()).padLeft(10f).row();</b>
&nbsp;                }
&nbsp;            });
&nbsp;
&nbsp;            //import
<b class="nc">&nbsp;            if(sector.hasBase()){</b>
<b class="nc">&nbsp;                displayItems(c, 1f, sector.info.importStats(sector.planet), &quot;@sectors.import&quot;, t -&gt; {</b>
<b class="nc">&nbsp;                    sector.info.eachImport(sector.planet, other -&gt; {</b>
<b class="nc">&nbsp;                        String ic = other.iconChar();</b>
<b class="nc">&nbsp;                        t.add(Iconc.rightOpen + &quot; &quot; + (ic == null || ic.isEmpty() ? &quot;&quot; : ic + &quot; &quot;) + other.name()).padLeft(10f).row();</b>
&nbsp;                    });
&nbsp;                });
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            ItemSeq items = sector.items();</b>
&nbsp;
&nbsp;            //stored resources
<b class="nc">&nbsp;            if(sector.hasBase() &amp;&amp; items.total &gt; 0){</b>
&nbsp;
<b class="nc">&nbsp;                c.add(&quot;@sectors.stored&quot;).left().row();</b>
<b class="nc">&nbsp;                c.table(t -&gt; {</b>
<b class="nc">&nbsp;                    t.left();</b>
&nbsp;
<b class="nc">&nbsp;                    t.table(res -&gt; {</b>
&nbsp;
<b class="nc">&nbsp;                        int i = 0;</b>
<b class="nc">&nbsp;                        for(ItemStack stack : items){</b>
<b class="nc">&nbsp;                            res.image(stack.item.uiIcon).padRight(3);</b>
<b class="nc">&nbsp;                            res.add(UI.formatAmount(Math.max(stack.amount, 0))).color(Color.lightGray);</b>
<b class="nc">&nbsp;                            if(++i % 4 == 0){</b>
<b class="nc">&nbsp;                                res.row();</b>
&nbsp;                            }
<b class="nc">&nbsp;                        }</b>
<b class="nc">&nbsp;                    }).padLeft(10f);</b>
<b class="nc">&nbsp;                }).left().row();</b>
&nbsp;            }
&nbsp;        });
&nbsp;
<b class="nc">&nbsp;        dialog.addCloseButton();</b>
&nbsp;
<b class="nc">&nbsp;        if(sector.hasBase()){</b>
<b class="nc">&nbsp;            dialog.buttons.button(&quot;@sector.abandon&quot;, Icon.cancel, () -&gt; abandonSectorConfirm(sector, dialog::hide));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        dialog.show();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void abandonSectorConfirm(Sector sector, Runnable listener){
<b class="nc">&nbsp;        ui.showConfirm(&quot;@sector.abandon.confirm&quot;, () -&gt; {</b>
<b class="nc">&nbsp;            if(listener != null) listener.run();</b>
&nbsp;
<b class="nc">&nbsp;            if(sector.isBeingPlayed()){</b>
<b class="nc">&nbsp;                hide();</b>
&nbsp;                //after dialog is hidden
<b class="nc">&nbsp;                Time.runTask(7f, () -&gt; {</b>
&nbsp;                    //force game over in a more dramatic fashion
<b class="nc">&nbsp;                    for(var core : player.team().cores().copy()){</b>
<b class="nc">&nbsp;                        core.kill();</b>
<b class="nc">&nbsp;                    }</b>
&nbsp;                });
&nbsp;            }else{
<b class="nc">&nbsp;                if(sector.save != null){</b>
<b class="nc">&nbsp;                    sector.save.delete();</b>
&nbsp;                }
<b class="nc">&nbsp;                sector.save = null;</b>
&nbsp;            }
<b class="nc">&nbsp;            updateSelected();</b>
<b class="nc">&nbsp;            rebuildList();</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    void addSurvivedInfo(Sector sector, Table table, boolean wrap){
<b class="nc">&nbsp;        if(!wrap){</b>
<b class="nc">&nbsp;            table.add(sector.planet.allowWaveSimulation ? Core.bundle.format(&quot;sectors.underattack&quot;, (int)(sector.info.damage * 100)) : &quot;@sectors.underattack.nodamage&quot;).wrapLabel(wrap).row();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(sector.planet.allowWaveSimulation &amp;&amp; sector.info.wavesSurvived &gt;= 0 &amp;&amp; sector.info.wavesSurvived - sector.info.wavesPassed &gt;= 0 &amp;&amp; !sector.isBeingPlayed()){</b>
<b class="nc">&nbsp;            int toCapture = sector.info.attack || sector.info.winWave &lt;= 1 ? -1 : sector.info.winWave - (sector.info.wave + sector.info.wavesPassed);</b>
<b class="nc">&nbsp;            boolean plus = (sector.info.wavesSurvived - sector.info.wavesPassed) &gt;= SectorDamage.maxRetWave - 1;</b>
<b class="nc">&nbsp;            table.add(Core.bundle.format(&quot;sectors.survives&quot;, Math.min(sector.info.wavesSurvived - sector.info.wavesPassed, toCapture &lt;= 0 ? 200 : toCapture) +</b>
<b class="nc">&nbsp;            (plus ? &quot;+&quot; : &quot;&quot;) + (toCapture &lt; 0 ? &quot;&quot; : &quot;/&quot; + toCapture))).wrapLabel(wrap).row();</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    void selectSector(Sector sector){
<b class="nc">&nbsp;        selected = sector;</b>
<b class="nc">&nbsp;        updateSelected();</b>
&nbsp;    }
&nbsp;
&nbsp;    void updateSelected(){
<b class="nc">&nbsp;        Sector sector = selected;</b>
<b class="nc">&nbsp;        Table stable = sectorTop;</b>
&nbsp;
<b class="nc">&nbsp;        if(sector == null){</b>
<b class="nc">&nbsp;            stable.clear();</b>
<b class="nc">&nbsp;            stable.visible = false;</b>
&nbsp;            return;
&nbsp;        }
<b class="nc">&nbsp;        stable.visible = true;</b>
&nbsp;
<b class="nc">&nbsp;        float x = stable.getX(Align.center), y = stable.getY(Align.center);</b>
<b class="nc">&nbsp;        stable.clear();</b>
<b class="nc">&nbsp;        stable.background(Styles.black6);</b>
&nbsp;
<b class="nc">&nbsp;        stable.table(title -&gt; {</b>
<b class="nc">&nbsp;            title.add(&quot;[accent]&quot; + sector.name()).padLeft(3);</b>
<b class="nc">&nbsp;            if(sector.preset == null){</b>
<b class="nc">&nbsp;                title.add().growX();</b>
&nbsp;
<b class="nc">&nbsp;                title.button(Icon.pencilSmall, Styles.clearNonei, () -&gt; {</b>
<b class="nc">&nbsp;                   ui.showTextInput(&quot;@sectors.rename&quot;, &quot;@name&quot;, 20, sector.name(), v -&gt; {</b>
<b class="nc">&nbsp;                       sector.setName(v);</b>
<b class="nc">&nbsp;                       updateSelected();</b>
<b class="nc">&nbsp;                       rebuildList();</b>
&nbsp;                   });
<b class="nc">&nbsp;                }).size(40f).padLeft(4);</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            var icon = sector.info.contentIcon != null ?</b>
<b class="nc">&nbsp;                new TextureRegionDrawable(sector.info.contentIcon.uiIcon) :</b>
<b class="nc">&nbsp;                Icon.icons.get(sector.info.icon + &quot;Small&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            title.button(icon == null ? Icon.noneSmall : icon, Styles.clearNonei, iconSmall, () -&gt; {</b>
&nbsp;                //TODO use IconSelectDialog
<b class="nc">&nbsp;                new Dialog(&quot;&quot;){{</b>
<b class="nc">&nbsp;                    closeOnBack();</b>
<b class="nc">&nbsp;                    setFillParent(true);</b>
&nbsp;
<b class="nc">&nbsp;                    Runnable refresh = () -&gt; {</b>
<b class="nc">&nbsp;                        sector.saveInfo();</b>
<b class="nc">&nbsp;                        hide();</b>
<b class="nc">&nbsp;                        updateSelected();</b>
<b class="nc">&nbsp;                        rebuildList();</b>
&nbsp;                    };
&nbsp;
<b class="nc">&nbsp;                    cont.pane(t -&gt; {</b>
<b class="nc">&nbsp;                        resized(true, () -&gt; {</b>
<b class="nc">&nbsp;                            t.clearChildren();</b>
<b class="nc">&nbsp;                            t.marginRight(19f);</b>
<b class="nc">&nbsp;                            t.defaults().size(48f);</b>
&nbsp;
<b class="nc">&nbsp;                            t.button(Icon.none, Styles.squareTogglei, () -&gt; {</b>
<b class="nc">&nbsp;                                sector.info.icon = null;</b>
<b class="nc">&nbsp;                                sector.info.contentIcon = null;</b>
<b class="nc">&nbsp;                                refresh.run();</b>
<b class="nc">&nbsp;                            }).checked(sector.info.icon == null &amp;&amp; sector.info.contentIcon == null);</b>
&nbsp;
<b class="nc">&nbsp;                            int cols = (int)Math.min(20, Core.graphics.getWidth() / Scl.scl(52f));</b>
&nbsp;
<b class="nc">&nbsp;                            int i = 1;</b>
<b class="nc">&nbsp;                            for(var key : accessibleIcons){</b>
<b class="nc">&nbsp;                                var value = Icon.icons.get(key);</b>
&nbsp;
<b class="nc">&nbsp;                                t.button(value, Styles.squareTogglei, () -&gt; {</b>
<b class="nc">&nbsp;                                    sector.info.icon = key;</b>
<b class="nc">&nbsp;                                    sector.info.contentIcon = null;</b>
<b class="nc">&nbsp;                                    refresh.run();</b>
<b class="nc">&nbsp;                                }).checked(key.equals(sector.info.icon));</b>
&nbsp;
<b class="nc">&nbsp;                                if(++i % cols == 0) t.row();</b>
&nbsp;                            }
&nbsp;
<b class="nc">&nbsp;                            for(ContentType ctype : defaultContentIcons){</b>
<b class="nc">&nbsp;                                t.row();</b>
<b class="nc">&nbsp;                                t.image().colspan(cols).growX().width(Float.NEGATIVE_INFINITY).height(3f).color(Pal.accent);</b>
<b class="nc">&nbsp;                                t.row();</b>
&nbsp;
<b class="nc">&nbsp;                                i = 0;</b>
<b class="nc">&nbsp;                                for(UnlockableContent u : content.getBy(ctype).&lt;UnlockableContent&gt;as()){</b>
<b class="nc">&nbsp;                                    if(!u.isHidden() &amp;&amp; u.unlocked()){</b>
<b class="nc">&nbsp;                                        t.button(new TextureRegionDrawable(u.uiIcon), Styles.squareTogglei, iconMed, () -&gt; {</b>
<b class="nc">&nbsp;                                            sector.info.icon = null;</b>
<b class="nc">&nbsp;                                            sector.info.contentIcon = u;</b>
<b class="nc">&nbsp;                                            refresh.run();</b>
<b class="nc">&nbsp;                                        }).checked(sector.info.contentIcon == u);</b>
&nbsp;
<b class="nc">&nbsp;                                        if(++i % cols == 0) t.row();</b>
&nbsp;                                    }
<b class="nc">&nbsp;                                }</b>
&nbsp;                            }
&nbsp;                        });
&nbsp;                    });
<b class="nc">&nbsp;                    buttons.button(&quot;@back&quot;, Icon.left, this::hide).size(210f, 64f);</b>
<b class="nc">&nbsp;                }}.show();</b>
<b class="nc">&nbsp;            }).size(40f).tooltip(&quot;@sector.changeicon&quot;);</b>
<b class="nc">&nbsp;        }).row();</b>
&nbsp;
<b class="nc">&nbsp;        stable.image().color(Pal.accent).fillX().height(3f).pad(3f).row();</b>
&nbsp;
<b class="nc">&nbsp;        boolean locked = sector.preset != null &amp;&amp; sector.preset.locked() &amp;&amp; !sector.hasBase() &amp;&amp; sector.preset.techNode != null;</b>
&nbsp;
<b class="nc">&nbsp;        if(locked){</b>
<b class="nc">&nbsp;            stable.table(r -&gt; {</b>
<b class="nc">&nbsp;                r.add(&quot;@complete&quot;).colspan(2).left();</b>
<b class="nc">&nbsp;                r.row();</b>
<b class="nc">&nbsp;                for(Objective o : sector.preset.techNode.objectives){</b>
<b class="nc">&nbsp;                    if(o.complete()) continue;</b>
&nbsp;
<b class="nc">&nbsp;                    r.add(&quot;&gt; &quot; + o.display()).color(Color.lightGray).left();</b>
<b class="nc">&nbsp;                    r.image(o.complete() ? Icon.ok : Icon.cancel, o.complete() ? Color.lightGray : Color.scarlet).padLeft(3);</b>
<b class="nc">&nbsp;                    r.row();</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }).row();</b>
<b class="nc">&nbsp;        }else if(!sector.hasBase()){</b>
<b class="nc">&nbsp;            stable.add(Core.bundle.get(&quot;sectors.threat&quot;) + &quot; [accent]&quot; + sector.displayThreat()).row();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(sector.isAttacked()){</b>
<b class="nc">&nbsp;            addSurvivedInfo(sector, stable, false);</b>
<b class="nc">&nbsp;        }else if(sector.hasBase() &amp;&amp; sector.planet.campaignRules.sectorInvasion &amp;&amp; sector.near().contains(Sector::hasEnemyBase)){</b>
<b class="nc">&nbsp;            stable.add(&quot;@sectors.vulnerable&quot;);</b>
<b class="nc">&nbsp;            stable.row();</b>
<b class="nc">&nbsp;        }else if(!sector.hasBase() &amp;&amp; sector.hasEnemyBase()){</b>
<b class="nc">&nbsp;            stable.add(&quot;@sectors.enemybase&quot;);</b>
<b class="nc">&nbsp;            stable.row();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(sector.save != null &amp;&amp; sector.info.resources.any()){</b>
<b class="nc">&nbsp;            stable.table(t -&gt; {</b>
<b class="nc">&nbsp;                t.add(&quot;@sectors.resources&quot;).padRight(4);</b>
<b class="nc">&nbsp;                for(UnlockableContent c : sector.info.resources){</b>
<b class="nc">&nbsp;                    if(c == null) continue; //apparently this is possible.</b>
<b class="nc">&nbsp;                    t.image(c.uiIcon).padRight(3).scaling(Scaling.fit).size(iconSmall);</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;            }).padLeft(10f).fillX().row();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        stable.row();</b>
&nbsp;
<b class="nc">&nbsp;        if(sector.hasBase()){</b>
<b class="nc">&nbsp;            stable.button(&quot;@stats&quot;, Icon.info, Styles.cleart, () -&gt; showStats(sector)).height(40f).fillX().row();</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if((sector.hasBase() &amp;&amp; mode == look) || canSelect(sector) || (sector.preset != null &amp;&amp; sector.preset.alwaysUnlocked) || debugSelect){</b>
<b class="nc">&nbsp;            stable.button(</b>
<b class="nc">&nbsp;                mode == select ? &quot;@sectors.select&quot; :</b>
<b class="nc">&nbsp;                sector.isBeingPlayed() ? &quot;@sectors.resume&quot; :</b>
<b class="nc">&nbsp;                sector.hasBase() ? &quot;@sectors.go&quot; :</b>
<b class="nc">&nbsp;                locked ? &quot;@locked&quot; : &quot;@sectors.launch&quot;,</b>
<b class="nc">&nbsp;                locked ? Icon.lock : Icon.play, this::playSelected).growX().height(54f).minWidth(170f).padTop(4).disabled(locked);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        stable.pack();</b>
<b class="nc">&nbsp;        stable.setPosition(x, y, Align.center);</b>
&nbsp;
<b class="nc">&nbsp;        stable.act(0f);</b>
&nbsp;    }
&nbsp;
&nbsp;    void playSelected(){
<b class="nc">&nbsp;        if(selected == null) return;</b>
&nbsp;
<b class="nc">&nbsp;        Sector sector = selected;</b>
&nbsp;
<b class="nc">&nbsp;        if(sector.isBeingPlayed()){</b>
&nbsp;            //already at this sector
<b class="nc">&nbsp;            hide();</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(sector.preset != null &amp;&amp; sector.preset.locked() &amp;&amp; sector.preset.techNode != null &amp;&amp; !sector.hasBase()){</b>
&nbsp;            return;
&nbsp;        }
&nbsp;
&nbsp;        //make sure there are no under-attack sectors (other than this one)
<b class="nc">&nbsp;        for(Planet planet : content.planets()){</b>
<b class="nc">&nbsp;            if(!planet.allowWaveSimulation &amp;&amp; !debugSelect &amp;&amp; planet.allowWaveSimulation == sector.planet.allowWaveSimulation){</b>
&nbsp;                //if there are two or more attacked sectors... something went wrong, don&#39;t show the dialog to prevent softlock
<b class="nc">&nbsp;                Sector attacked = planet.sectors.find(s -&gt; s.isAttacked() &amp;&amp; s != sector);</b>
<b class="nc">&nbsp;                if(attacked != null &amp;&amp;  planet.sectors.count(s -&gt; s.isAttacked()) &lt; 2){</b>
<b class="nc">&nbsp;                    BaseDialog dialog = new BaseDialog(&quot;@sector.noswitch.title&quot;);</b>
<b class="nc">&nbsp;                    dialog.cont.add(bundle.format(&quot;sector.noswitch&quot;, attacked.name(), attacked.planet.localizedName)).width(400f).labelAlign(Align.center).center().wrap();</b>
<b class="nc">&nbsp;                    dialog.addCloseButton();</b>
<b class="nc">&nbsp;                    dialog.buttons.button(&quot;@sector.view&quot;, Icon.eyeSmall, () -&gt; {</b>
<b class="nc">&nbsp;                        dialog.hide();</b>
<b class="nc">&nbsp;                        lookAt(attacked);</b>
<b class="nc">&nbsp;                        selectSector(attacked);</b>
&nbsp;                    });
<b class="nc">&nbsp;                    dialog.show();</b>
&nbsp;
&nbsp;                    return;
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        boolean shouldHide = true;</b>
&nbsp;
&nbsp;        //save before launch.
<b class="nc">&nbsp;        if(control.saves.getCurrent() != null &amp;&amp; Vars.state.isGame() &amp;&amp; mode != select){</b>
&nbsp;            try{
<b class="nc">&nbsp;                control.saves.getCurrent().save();</b>
<b class="nc">&nbsp;            }catch(Throwable e){</b>
<b class="nc">&nbsp;                e.printStackTrace();</b>
<b class="nc">&nbsp;                ui.showException(&quot;[accent]&quot; + Core.bundle.get(&quot;savefail&quot;), e);</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(mode == look &amp;&amp; !sector.hasBase()){</b>
<b class="nc">&nbsp;            shouldHide = false;</b>
<b class="nc">&nbsp;            Sector from = findLauncher(sector);</b>
&nbsp;
<b class="nc">&nbsp;            if(from == null){</b>
&nbsp;                //clear loadout information, so only the basic loadout gets used
<b class="nc">&nbsp;                universe.clearLoadoutInfo();</b>
&nbsp;                //free launch.
<b class="nc">&nbsp;                control.playSector(sector);</b>
&nbsp;            }else{
<b class="nc">&nbsp;                CoreBlock block = sector.allowLaunchSchematics() ? (from.info.bestCoreType instanceof CoreBlock b ? b : (CoreBlock)from.planet.defaultCore) : (CoreBlock)from.planet.defaultCore;</b>
&nbsp;
<b class="nc">&nbsp;                loadouts.show(block, from, sector, () -&gt; {</b>
<b class="nc">&nbsp;                    var loadout = universe.getLastLoadout();</b>
<b class="nc">&nbsp;                    var schemCore = loadout.findCore();</b>
<b class="nc">&nbsp;                    from.removeItems(loadout.requirements());</b>
<b class="nc">&nbsp;                    from.removeItems(universe.getLaunchResources());</b>
&nbsp;
<b class="nc">&nbsp;                    Events.fire(new SectorLaunchLoadoutEvent(sector, from, loadout));</b>
&nbsp;
<b class="nc">&nbsp;                    CoreBuild core = player.team().core();</b>
<b class="nc">&nbsp;                    if(core == null || settings.getBool(&quot;skipcoreanimation&quot;)){</b>
&nbsp;                        //just... go there
<b class="nc">&nbsp;                        control.playSector(from, sector);</b>
&nbsp;                        //hide only after load screen is shown
<b class="nc">&nbsp;                        Time.runTask(8f, this::hide);</b>
&nbsp;                    }else{
&nbsp;                        //hide immediately so launch sector is visible
<b class="nc">&nbsp;                        hide();</b>
&nbsp;
&nbsp;                        //allow planet dialog to finish hiding before actually launching
<b class="nc">&nbsp;                        Time.runTask(5f, () -&gt; {</b>
<b class="nc">&nbsp;                            Runnable doLaunch = () -&gt; {</b>
<b class="nc">&nbsp;                                renderer.showLaunch(core, schemCore);</b>
&nbsp;                                //run with less delay, as the loading animation is delayed by several frames
<b class="nc">&nbsp;                                Time.runTask(core.landDuration() - 8f, () -&gt; control.playSector(from, sector));</b>
&nbsp;                            };
&nbsp;
&nbsp;                            //load launchFrom sector right before launching so animation is correct
<b class="nc">&nbsp;                            if(!from.isBeingPlayed()){</b>
&nbsp;                                //run *after* the loading animation is done
<b class="nc">&nbsp;                                Time.runTask(9f, doLaunch);</b>
<b class="nc">&nbsp;                                control.playSector(from);</b>
&nbsp;                            }else{
<b class="nc">&nbsp;                                doLaunch.run();</b>
&nbsp;                            }
&nbsp;                        });
&nbsp;                    }
&nbsp;                });
&nbsp;            }
<b class="nc">&nbsp;        }else if(mode == select){</b>
<b class="nc">&nbsp;            listener.get(sector);</b>
<b class="nc">&nbsp;        }else if(mode == planetLaunch){ //TODO make sure it doesn&#39;t have a base already.</b>
&nbsp;            //TODO animation
&nbsp;            //schematic selection and cost handled by listener
<b class="nc">&nbsp;            listener.get(sector);</b>
&nbsp;            //unlock right before launch
<b class="nc">&nbsp;            sector.planet.unlockedOnLand.each(UnlockableContent::unlock);</b>
<b class="nc">&nbsp;            control.playSector(sector);</b>
&nbsp;        }else{
&nbsp;            //sector should have base here
<b class="nc">&nbsp;            control.playSector(sector);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if(shouldHide) hide();</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    public enum Mode{</b>
&nbsp;        /** Look around for existing sectors. Can only deploy. */
<b class="nc">&nbsp;        look,</b>
&nbsp;        /** Select a sector for some purpose. */
<b class="nc">&nbsp;        select,</b>
&nbsp;        /** Launch between planets. */
<b class="nc">&nbsp;        planetLaunch</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-10-10 13:22</div>
</div>
</body>
</html>
